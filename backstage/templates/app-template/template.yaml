apiVersion: scaffolder.backstage.io/v1beta3
kind: Template
metadata:
  name: app-template
  title: App Template (Kong + ServiceMonitor)
  description: Scaffold a service with Kong ingress, ServiceMonitor, and dashboard config.
spec:
  owner: platform
  type: service
  parameters:
    - title: App basics
      required:
        - app_name
        - namespace
        - owner_team
        - repoUrl
      properties:
        app_name:
          title: App name
          type: string
          description: Service name (lowercase, kebab-case)
          pattern: "^[a-z0-9-]+$"
        namespace:
          title: Namespace
          type: string
          default: default
        owner_team:
          title: Owner team
          type: string
          description: GitHub team slug (e.g., checkout-team)
          pattern: "^[a-z0-9-]+$"
        system:
          title: System
          type: string
          description: Backstage system (optional)
        description:
          title: Description
          type: string
          default: "Golden Path service"
        repoUrl:
          title: Repo URL
          type: string
          description: GitHub repo (e.g., github.com?owner=org&repo=repo)
    - title: Governance
      required:
        - lifecycle
        - service_tier
        - data_classification
      properties:
        lifecycle:
          title: Lifecycle
          type: string
          enum:
            - experimental
            - production
            - deprecated
          default: experimental
        service_tier:
          title: Service tier
          type: string
          enum:
            - tier-1
            - tier-2
            - tier-3
          default: tier-3
        data_classification:
          title: Data classification
          type: string
          enum:
            - public
            - internal
            - confidential
            - restricted
          default: internal
    - title: Runtime
      properties:
        app_image:
          title: Container image
          type: string
        app_version:
          title: App version
          type: string
          default: "latest"
        app_port:
          title: Container port
          type: number
          default: 8080
        service_port:
          title: Service port
          type: number
          default: 80
        replicas:
          title: Replicas
          type: number
          default: 1
        cpu_request:
          title: CPU request
          type: string
          default: "100m"
        memory_request:
          title: Memory request
          type: string
          default: "128Mi"
        cpu_limit:
          title: CPU limit
          type: string
          default: "500m"
        memory_limit:
          title: Memory limit
          type: string
          default: "512Mi"
        env:
          title: Environment label
          type: string
          default: "dev"
        team:
          title: Team label
          type: string
          default: "platform"
        build_id:
          title: Build ID label
          type: string
          default: "unknown"
    - title: Ingress + Kong
      properties:
        app_host:
          title: Ingress host
          type: string
          default: "app.example.com"
        kong_auth_plugin:
          title: Kong auth plugin name
          type: string
          default: "app-auth"
        kong_rate_limit_plugin:
          title: Kong rate-limit plugin name
          type: string
          default: "app-rate-limit"
        kong_consumer_name:
          title: Kong consumer name
          type: string
          default: "app-consumer"
        kong_consumer_username:
          title: Kong consumer username
          type: string
          default: "app"
        kong_consumer_id:
          title: Kong consumer ID
          type: string
          default: "app"
        kong_credential_secret_name:
          title: Kong credential secret name
          type: string
          default: "app-apikey"
        kong_api_key:
          title: Kong API key
          type: string
          default: "change-me"
        rate_limit_per_min:
          title: Kong rate limit per minute
          type: number
          default: 60
    - title: Kubernetes access
      properties:
        service_account_name:
          title: Service account name
          type: string
          default: "app"
  steps:
    - id: fetch-base
      name: Fetch app template
      action: fetch:template
      input:
        url: ../../apps/fast-api-app-template
        targetPath: .
        values:
          app_name: ${{ parameters.app_name }}
          namespace: ${{ parameters.namespace }}
          owner: group:${{ parameters.owner_team }}
          owner_team: ${{ parameters.owner_team }}
          system: ${{ parameters.system }}
          description: ${{ parameters.description }}
          lifecycle: ${{ parameters.lifecycle }}
          service_tier: ${{ parameters.service_tier }}
          data_classification: ${{ parameters.data_classification }}
          app_image: ${{ parameters.app_image }}
          app_version: ${{ parameters.app_version }}
          app_port: ${{ parameters.app_port }}
          service_port: ${{ parameters.service_port }}
          replicas: ${{ parameters.replicas }}
          cpu_request: ${{ parameters.cpu_request }}
          memory_request: ${{ parameters.memory_request }}
          cpu_limit: ${{ parameters.cpu_limit }}
          memory_limit: ${{ parameters.memory_limit }}
          env: ${{ parameters.env }}
          team: ${{ parameters.team }}
          build_id: ${{ parameters.build_id }}
          app_host: ${{ parameters.app_host }}
          kong_auth_plugin: ${{ parameters.kong_auth_plugin }}
          kong_rate_limit_plugin: ${{ parameters.kong_rate_limit_plugin }}
          kong_consumer_name: ${{ parameters.kong_consumer_name }}
          kong_consumer_username: ${{ parameters.kong_consumer_username }}
          kong_consumer_id: ${{ parameters.kong_consumer_id }}
          kong_credential_secret_name: ${{ parameters.kong_credential_secret_name }}
          kong_api_key: ${{ parameters.kong_api_key }}
          rate_limit_per_min: ${{ parameters.rate_limit_per_min }}
          service_account_name: ${{ parameters.service_account_name }}
    - id: publish
      name: Publish repo
      action: publish:github
      input:
        repoUrl: ${{ parameters.repoUrl }}
        description: ${{ parameters.description }}
    - id: register
      name: Register in catalog
      action: catalog:register
      input:
        repoContentsUrl: ${{ steps.publish.output.repoContentsUrl }}
        catalogInfoPath: /catalog-info.yaml
  output:
    links:
      - title: Repository
        url: ${{ steps.publish.output.remoteUrl }}
      - title: Catalog Entity
        icon: catalog
        entityRef: ${{ steps.register.output.entityRef }}
