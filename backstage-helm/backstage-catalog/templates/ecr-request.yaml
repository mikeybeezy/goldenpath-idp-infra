apiVersion: scaffolder.backstage.io/v1beta3
kind: Template
metadata:
  name: ecr-request
  title: Request ECR Repository
  description: Request a new AWS ECR repository via GitOps. Triggers a PR to create the repository with correct governance.
  tags:
    - aws
    - ecr
    - infrastructure
    - gitops
spec:
  owner: platform-team
  type: service

  parameters:
    - title: Repository Details
      required:
        - name
        - owner
        - requester
        - domain
        - environment
        - risk
      properties:
        name:
          title: Repository Name
          type: string
          description: Unique name for the ECR repository (e.g., payment-service-cache).
          ui:autofocus: true
          pattern: '^[a-z][a-z0-9-]*$'
        owner:
          title: Owner
          type: string
          description: Team that owns this repository.
          enum:
            - platform-team
            - security-team
            - operations-team
            - sre-team
            - unknown
            - app-team
            - database-team
          default: platform-team
        requester:
          title: Requesting User
          type: string
          description: Requester (e.g., daniel-deans).
          pattern: '^[a-z0-9-]+$'
        domain:
          title: Domain
          type: string
          description: Domain for this registry.
          enum:
            - platform-core
            - delivery
            - observability
            - governance
            - security
            - cost
          default: delivery
        environment:
          title: Environment
          type: string
          description: Target environment for the repository.
          enum:
            - dev
            - test
            - staging
            - prod
          default: dev
        risk:
          title: Risk Classification
          type: string
          description: Data sensitivity level.
          enum:
            - low
            - medium
            - high
          default: low

  steps:
    - id: debug-inputs
      name: Debug Inputs
      action: debug:log
      input:
        message: |
          ECR template inputs:
          name=${{ parameters.name }}
          owner=${{ parameters.owner }}
          requester=${{ parameters.requester }}
          domain=${{ parameters.domain }}
          environment=${{ parameters.environment }}
          risk=${{ parameters.risk }}

    - id: trigger-workflow
      name: Trigger Creation Workflow
      action: github:actions:dispatch
      input:
        repoUrl: github.com?owner=mikeybeezy&repo=goldenpath-idp-infra
        workflowId: create-ecr-registry.yml
        branchOrTagName: main
        workflowInputs:
          base_branch: development
          registry_name: ${{ parameters.name }}
          owner: ${{ parameters.owner }}
          user: ${{ parameters.requester }}
          domain: ${{ parameters.domain }}
          environment: ${{ parameters.environment }}
          risk: ${{ parameters.risk }}

  output:
    links:
      - title: Open Workflow Runs
        url: https://github.com/mikeybeezy/goldenpath-idp-infra/actions/workflows/create-ecr-registry.yml
      - title: PR Link (filtered by branch)
        url: https://github.com/mikeybeezy/goldenpath-idp-infra/pulls?q=is%3Apr+head%3Aregistry%2Fcreate-${{ parameters.name }}
      - title: PR List (fallback)
        url: https://github.com/mikeybeezy/goldenpath-idp-infra/pulls
      - title: Catalog Link (static; success = workflow run above)
        url: https://github.com/mikeybeezy/goldenpath-idp-infra/blob/main/docs/20-contracts/resource-catalogs/ecr-catalog.yaml
