apiVersion: scaffolder.backstage.io/v1beta3
kind: Template
metadata:
  name: ecr-request
  title: Request ECR Repository
  description: Request a new AWS ECR repository via GitOps. Triggers a PR to create the repository with correct governance.
  tags:
    - aws
    - ecr
    - infrastructure
    - gitops
spec:
  owner: platform-team
  type: service

  parameters:
    - title: Repository Details
      required:
        - name
        - owner
        - requester
        - domain
        - environment
        - risk
      properties:
        name:
          title: Repository Name
          type: string
          description: Unique name for the ECR repository (e.g., payment-service-cache).
          ui:autofocus: true
          pattern: '^[a-z][a-z0-9-]*$'
        repoUrl:
          title: Workflow Repo URL
          type: string
          description: GitHub repository hosting the ECR workflow.
          default: "github.com?owner=mikeybeezy&repo=goldenpath-idp-infra"
          ui:widget: hidden
        owner:
          title: Owner
          type: string
          description: Team that owns this repository.
          enum:
            - platform-team
            - security-team
            - operations-team
            - sre-team
            - unknown
            - app-team
            - database-team
          default: platform-team
        requester:
          title: Requesting User
          type: string
          description: Requester (e.g., daniel-deans).
          pattern: '^[a-z0-9-]+$'
        domain:
          title: Domain
          type: string
          description: Domain for this registry.
          enum:
            - platform-core
            - delivery
            - observability
            - governance
            - security
            - cost
          default: delivery
        environment:
          title: Environment
          type: string
          description: Target environment for the repository.
          enum:
            - dev
            - test
            - staging
            - prod
          default: dev
        risk:
          title: Risk Classification
          type: string
          description: Data sensitivity level.
          enum:
            - low
            - medium
            - high
          default: low

  steps:
    - id: trigger-workflow
      name: Trigger Creation Workflow
      action: github:actions:dispatch
      input:
        repoUrl: ${{ parameters.repoUrl }}
        workflowId: create-ecr-registry.yml
        branchOrTagName: main
        workflowInputs:
          registry_name: ${{ parameters.name }}
          owner: ${{ parameters.owner }}
          user: ${{ parameters.requester }}
          domain: ${{ parameters.domain }}
          environment: ${{ parameters.environment }}
          risk: ${{ parameters.risk }}

  output:
    links:
      - title: Open Workflow Run
        url: ${{ steps['trigger-workflow'].output.link }}
      - title: Repository URL (After Merge)
        url: https://github.com/mikeybeezy/goldenpath-idp-infra/blob/main/docs/20-contracts/catalogs/ecr-catalog.yaml
