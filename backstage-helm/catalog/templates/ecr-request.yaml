apiVersion: scaffolder.backstage.io/v1beta3
kind: Template
metadata:
  name: ecr-request
  title: Request ECR Repository
  description: Request a new AWS ECR repository via GitOps. Triggers a PR to create the repository with correct governance.
  tags:
    - aws
    - ecr
    - infrastructure
    - gitops
spec:
  owner: platform-team
  type: service

  parameters:
    - title: Repository Details
      required:
        - name
        - owner
        - requester
        - domain
        - environment
        - risk
      properties:
        name:
          title: Repository Name
          type: string
          description: Unique name for the ECR repository (e.g., payment-service-cache).
          ui:autofocus: true
          pattern: '^[a-z][a-z0-9-]*$'
        owner:
          title: Owner
          type: string
          description: Team that owns this repository.
          enum:
            - platform-team
            - security-team
            - operations-team
            - sre-team
            - unknown
            - app-team
            - database-team
          default: platform-team
        requester:
          title: Requesting User
          type: string
          description: Requester (e.g., daniel-deans).
          pattern: '^[a-z0-9-]+$'
        domain:
          title: Domain
          type: string
          description: Domain for this registry.
          enum:
            - platform-core
            - delivery
            - observability
            - governance
            - security
            - cost
          default: delivery
        environment:
          title: Environment
          type: string
          description: Target environment for the repository.
          enum:
            - dev
            - test
            - staging
            - prod
          default: dev
        risk:
          title: Risk Classification
          type: string
          description: Data sensitivity level.
          enum:
            - low
            - medium
            - high
          default: low

  steps:
    - id: debug-inputs
      name: Debug Inputs
      action: debug:log
      input:
        message: |
          ECR template inputs:
          name=${{ parameters.name }}
          owner=${{ parameters.owner }}
          requester=${{ parameters.requester }}
          domain=${{ parameters.domain }}
          environment=${{ parameters.environment }}
          risk=${{ parameters.risk }}

    - id: fetch-repo
      name: Fetch Repository
      action: fetch:plain
      input:
        url: https://github.com/mikeybeezy/goldenpath-idp-infra
        targetPath: ./repo

    - id: scaffold-registry
      name: Scaffold Registry Changes
      action: command:execute
      input:
        command: python3
        args:
          - scripts/scaffold_ecr.py
          - --app-name
          - ${{ parameters.name }}
          - --owner
          - ${{ parameters.owner }}
          - --risk
          - ${{ parameters.risk }}
          - --environment
          - ${{ parameters.environment }}
          - --requester
          - ${{ parameters.requester }}
          - --domain
          - ${{ parameters.domain }}
        workingDirectory: ./repo

    - id: create-pr
      name: Create Pull Request
      action: publish:github:pull-request
      input:
        repoUrl: github.com?owner=mikeybeezy&repo=goldenpath-idp-infra
        title: "ECR registry: ${{ parameters.name }}"
        description: |
          ## ECR Registry Creation Request
          **Registry:** `${{ parameters.name }}`
          **Environment:** `${{ parameters.environment }}`
          **Owner:** `${{ parameters.owner }}`
          **Requested By:** `${{ parameters.requester }}`
          **Domain:** `${{ parameters.domain }}`
          **Risk:** `${{ parameters.risk }}`
        branchName: "ecr/${{ parameters.environment }}/${{ parameters.name }}"
        targetBranchName: main
        sourcePath: ./repo

  output:
    links:
      - title: Open Pull Request
        url: ${{ steps['create-pr'].output.pullRequestUrl }}
      - title: PR List (fallback)
        url: https://github.com/mikeybeezy/goldenpath-idp-infra/pulls
      - title: Catalog Link (static; success = PR link above)
        url: https://github.com/mikeybeezy/goldenpath-idp-infra/blob/main/docs/20-contracts/catalogs/ecr-catalog.yaml
