apiVersion: scaffolder.backstage.io/v1beta3
kind: Template
metadata:
  name: ecr-request
  title: Request ECR Repository
  description: Request a new AWS ECR repository via GitOps. Triggers a PR to create the repository with correct governance.
  tags:
    - aws
    - ecr
    - infrastructure
    - gitops
spec:
  owner: platform-team
  type: service

  parameters:
    - title: Repository Details
      required:
        - name
        - owner
        - environment
        - risk
      properties:
        name:
          title: Repository Name
          type: string
          description: Unique name for the ECR repository (e.g., payment-service-cache).
          ui:autofocus: true
          pattern: '^[a-z][a-z0-9-]*$'
        owner:
          title: Owner
          type: string
          description: Team that owns this repository (e.g., app-team-payment).
          ui:field: EntityPicker
          ui:options:
            catalogFilter:
              kind: Group
        environment:
          title: Environment
          type: string
          description: Target environment for the repository.
          enum:
            - dev
            - test
            - staging
            - prod
          default: dev
        risk:
          title: Risk Classification
          type: string
          description: Data sensitivity level.
          enum:
            - low
            - medium
            - high
          default: low

  steps:
    - id: trigger-workflow
      name: Trigger Creation Workflow
      action: github:actions:dispatch
      input:
        workflowId: create-ecr-registry.yml
        repo: goldenpath-idp-infra
        owner: mikeybeezy
        branchOrTagName: development
        workflowInputs:
          registry_name: ${{ parameters.name }}
          owner: ${{ parameters.owner }}
          environment: ${{ parameters.environment }}
          risk: ${{ parameters.risk }}

  output:
    links:
      - title: Open Workflow Run
        url: ${{ steps['trigger-workflow'].output.link }}
      - title: Repository URL (After Merge)
        url: https://github.com/mikeybeezy/goldenpath-idp-infra/blob/development/docs/20-contracts/catalogs/ecr-catalog.yaml
