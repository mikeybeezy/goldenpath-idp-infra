################################################################################
# EKS Request Schema - The Contract
#
# Defines the request contract for EKS cluster provisioning.
# Backstage templates and CI workflows should be thin consumers of this schema.
################################################################################

id: EKS_REQUEST_V1
version: "1.0"
type: request
domain: platform
owner: platform-team
status: proposed

metadata:
  description: "Contract for requesting EKS clusters and bootstrap runs"
  backstage_template: "catalog/templates/eks-request.yaml"
  parser_module: "scripts/eks_request_parser.py"
  parser_status: "active"
  terraform_root: "envs/{environment}/"
  workflow: ".github/workflows/eks-request-apply.yml"

################################################################################
# Property Definitions
################################################################################

properties:
  id:
    type: string
    pattern: "^EKS-[0-9]{4}$"
    description: "Unique request ID (e.g., EKS-0001)"

  environment:
    type: string
    enum_from: eks_environments
    description: "Target environment"

  clusterLifecycle:
    type: string
    enum:
      - ephemeral
    description: "Lifecycle for the cluster (ephemeral only for now)"

  region:
    type: string
    enum:
      - "eu-west-2"
    description: "AWS region"

  owner:
    type: string
    enum_from: owners
    description: "Owning team"

  requester:
    type: string
    description: "Requester name or service account"

  mode:
    type: string
    enum_from: eks_modes
    description: "cluster-only | bootstrap-only | cluster+bootstrap"

  buildId:
    type: string
    pattern: "^[0-9]{2}-[0-9]{2}-[0-9]{2}-[0-9]{2}$"
    description: "Required when mode includes cluster creation"

  clusterName:
    type: string
    pattern: "^[a-z0-9-]{3,40}$"
    description: "Cluster name"

  kubernetesVersion:
    type: string
    enum_from: kubernetes_versions
    description: "EKS Kubernetes version"

  nodeTier:
    type: string
    enum_from: eks_node_tiers
    description: "Node sizing tier (maps to instance type)"

  instance_type:
    type: string
    description: "Explicit instance type (optional override)"

  nodeMin:
    type: integer
    minimum: 1
    description: "Minimum node count"

  nodeDesired:
    type: integer
    minimum: 1
    description: "Desired node count"

  nodeMax:
    type: integer
    minimum: 1
    description: "Maximum node count"

  capacityType:
    type: string
    enum_from: eks_capacity_types
    description: "ON_DEMAND or SPOT"

  autoscalerEnabled:
    type: boolean
    default: true
    description: "Enable cluster autoscaler"

  gitopsController:
    type: string
    enum_from: eks_gitops_controllers
    description: "GitOps controller"

  gitopsInstall:
    type: boolean
    default: true
    description: "Install GitOps controller"

  bootstrapProfile:
    type: string
    enum_from: eks_bootstrap_profiles
    description: "Bootstrap profile selection (advisory; not wired to automation yet)"

  ingressProvider:
    type: string
    enum_from: eks_ingress_providers
    description: "Ingress provider (advisory; not wired to automation yet)"

  awsLbType:
    type: string
    enum_from: eks_aws_lb_types
    description: "AWS load balancer type (advisory; not wired to automation yet)"

  ingressInternal:
    type: boolean
    default: true
    description: "Internal load balancer (advisory; not wired to automation yet)"

  accessSsmBreakGlass:
    type: boolean
    default: true
    description: "Allow SSM access for break-glass (advisory; not wired to automation yet)"

  accessSshBreakGlass:
    type: boolean
    default: false
    description: "Allow SSH break-glass"

  sshKeyName:
    type: string
    description: "EC2 key pair name for SSH access"

  sshSourceSecurityGroupIds:
    type: array
    items:
      type: string
    description: "Security group IDs allowed to SSH"

  irsaEnabled:
    type: boolean
    default: false
    description: "Enable IRSA (advisory; not wired to automation yet)"

################################################################################
# Required Fields
################################################################################

required:
  - id
  - environment
  - region
  - owner
  - requester
  - mode
  - clusterName
  - kubernetesVersion
  - nodeDesired
  - nodeMax

################################################################################
# Conditional Rules
################################################################################

conditional_rules:
  - name: build_id_required_for_cluster
    description: "buildId required for cluster creation"
    when:
      mode:
        enum:
          - cluster-only
          - cluster+bootstrap
    then:
      buildId:
        required: true

  - name: node_min_default
    description: "nodeMin defaults to nodeDesired when omitted"
    when:
      nodeMin:
        defined: false
    then:
      nodeMin:
        default: nodeDesired

  - name: node_bounds
    description: "nodeMin <= nodeDesired <= nodeMax"
    when:
      nodeMax:
        defined: true
    then:
      nodeMax:
        greater_than_field: nodeDesired

################################################################################
# Output Artifacts
################################################################################

generates:
  terraform_tfvars:
    path: "envs/{environment}/clusters/generated/{id}.auto.tfvars.json"
    description: "Parser generates EKS tfvars inputs"
  catalog_entry:
    path: "docs/20-contracts/resource-catalogs/eks-catalog.yaml"
    description: "Workflow updates shared EKS catalog"
  audit_record:
    path: "governance/{environment}/eks_request_audit.csv"
    description: "Audit trail entry"
