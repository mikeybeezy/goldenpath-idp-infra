# Owner: platform
# Description: Manual apply for S3 request files (bucket creation).
# Relates-To: schemas/requests/s3.schema.yaml, ADR-0170
name: S3 Requests (Apply)

on:
  workflow_dispatch:
    inputs:
      request_file:
        description: "Path to S3 request file (e.g., docs/20-contracts/s3-requests/dev/S3-0001.yaml)"
        required: true
        type: string
      platform_approved:
        description: "Platform approval acknowledged"
        required: true
        default: false
        type: boolean
      allow_non_dev:
        description: "Allow non-dev apply (staging/prod)"
        required: false
        default: false
        type: boolean
      dry_run:
        description: "Dry run (validate and generate only, no Terraform apply)"
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  id-token: write

jobs:
  apply:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Validate S3 request
        run: |
          python3 scripts/s3_request_parser.py \
            --mode validate \
            --input-files "${{ inputs.request_file }}"

      - name: Generate tfvars
        run: |
          python3 scripts/s3_request_parser.py \
            --mode generate \
            --input-files "${{ inputs.request_file }}" \
            --output-root envs

      - name: Commit generated outputs
        run: |
          set -euo pipefail
          git config user.name "goldenpath-bot"
          git config user.email "goldenpath-bot@users.noreply.github.com"

          git add envs/**/s3/generated/*.auto.tfvars.json || true
          git add envs/generated/iam/*-s3-policy.json || true
          if git diff --cached --quiet; then
            echo "No generated changes to commit."
            exit 0
          fi

          git commit -m "chore(s3): generate tfvars and IAM policy output [skip ci]"
          git push

      - name: Resolve context
        id: context
        run: |
          set -euo pipefail
          FILE="${{ inputs.request_file }}"
          python3 - "$FILE" <<'PY' >> "$GITHUB_OUTPUT"
          import sys
          import yaml

          path = sys.argv[1]
          data = yaml.safe_load(open(path)) or {}
          spec = data.get("spec", {})

          env = data.get("environment") or data.get("metadata", {}).get("environment")
          s3_id = data.get("id")
          bucket_name = spec.get("bucketName")
          public_access = spec.get("publicAccess", "blocked")
          purpose_type = (spec.get("purpose") or {}).get("type", "")
          needs_approval = env != "dev" or public_access == "exception-approved" or purpose_type == "static-assets"

          print(f"ENV={env}")
          print(f"S3_ID={s3_id}")
          print(f"BUCKET_NAME={bucket_name}")
          print(f"PUBLIC_ACCESS={public_access}")
          print(f"PURPOSE_TYPE={purpose_type}")
          print(f"NEEDS_APPROVAL={'true' if needs_approval else 'false'}")
          PY

      - name: Guard non-dev requests
        if: steps.context.outputs.ENV != 'dev' && inputs.allow_non_dev != true
        run: |
          echo "Non-dev apply requires allow_non_dev=true"
          exit 1

      - name: Guard platform approval
        if: steps.context.outputs.NEEDS_APPROVAL == 'true' && inputs.platform_approved != true
        run: |
          echo "Platform approval is required for this request."
          echo "Context:"
          echo "  env=${{ steps.context.outputs.ENV }}"
          echo "  public_access=${{ steps.context.outputs.PUBLIC_ACCESS }}"
          echo "  purpose_type=${{ steps.context.outputs.PURPOSE_TYPE }}"
          echo "Set platform_approved=true to proceed."
          exit 1

      - name: Resolve backend config
        if: inputs.dry_run != true
        id: backend
        run: |
          set -euo pipefail
          ENV="${{ steps.context.outputs.ENV }}"
          case "$ENV" in
            dev)
              echo "BUCKET=goldenpath-idp-dev-bucket" >> "$GITHUB_OUTPUT"
              echo "LOCK_TABLE=goldenpath-idp-dev-locks" >> "$GITHUB_OUTPUT"
              echo "ROLE=${{ secrets.TF_AWS_IAM_ROLE_DEV_APPLY }}" >> "$GITHUB_OUTPUT"
              echo "REGION=ap-southeast-2" >> "$GITHUB_OUTPUT"
              ;;
            staging)
              echo "BUCKET=goldenpath-idp-staging-bucket" >> "$GITHUB_OUTPUT"
              echo "LOCK_TABLE=goldenpath-idp-staging-db" >> "$GITHUB_OUTPUT"
              echo "ROLE=${{ secrets.TF_AWS_IAM_ROLE_STAGING_APPLY }}" >> "$GITHUB_OUTPUT"
              echo "REGION=ap-southeast-2" >> "$GITHUB_OUTPUT"
              ;;
            prod)
              echo "BUCKET=goldenpath-idp-prod-bucket" >> "$GITHUB_OUTPUT"
              echo "LOCK_TABLE=goldenpath-idp-prod-db" >> "$GITHUB_OUTPUT"
              echo "ROLE=${{ secrets.TF_AWS_IAM_ROLE_PROD_APPLY }}" >> "$GITHUB_OUTPUT"
              echo "REGION=ap-southeast-2" >> "$GITHUB_OUTPUT"
              ;;
            test)
              echo "BUCKET=goldenpath-test-staging-bucket" >> "$GITHUB_OUTPUT"
              echo "LOCK_TABLE=goldenpath-idp-test-db" >> "$GITHUB_OUTPUT"
              echo "ROLE=${{ secrets.TF_AWS_IAM_ROLE_TEST_APPLY }}" >> "$GITHUB_OUTPUT"
              echo "REGION=ap-southeast-2" >> "$GITHUB_OUTPUT"
              ;;
            *)
              echo "Unsupported environment: $ENV"
              exit 1
              ;;
          esac

      - name: Dry run summary
        if: inputs.dry_run == true
        run: |
          echo "## S3 Request Apply (Dry Run)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Request | ${{ inputs.request_file }} |" >> $GITHUB_STEP_SUMMARY
          echo "| S3 ID | ${{ steps.context.outputs.S3_ID }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ steps.context.outputs.ENV }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Bucket | ${{ steps.context.outputs.BUCKET_NAME }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Dry run complete. Terraform apply was skipped." >> $GITHUB_STEP_SUMMARY

      - name: Setup Terraform
        if: inputs.dry_run != true
        uses: hashicorp/setup-terraform@v3

      - name: Configure AWS credentials (Apply Role)
        if: inputs.dry_run != true
        uses: aws-actions/configure-aws-credentials@v4.1.0
        with:
          aws-region: ${{ steps.backend.outputs.REGION }}
          role-to-assume: ${{ steps.backend.outputs.ROLE }}

      - name: Terraform Init
        if: inputs.dry_run != true
        run: |
          set -euo pipefail
          ENV="${{ steps.context.outputs.ENV }}"
          S3_ID="${{ steps.context.outputs.S3_ID }}"

          STATE_KEY="envs/${ENV}/s3/${S3_ID}/terraform.tfstate"

          terraform -chdir=envs/${ENV} init \
            -backend-config="bucket=${{ steps.backend.outputs.BUCKET }}" \
            -backend-config="key=${STATE_KEY}" \
            -backend-config="region=${{ steps.backend.outputs.REGION }}" \
            -backend-config="dynamodb_table=${{ steps.backend.outputs.LOCK_TABLE }}" \
            -backend-config="encrypt=true"

      - name: Terraform Apply
        if: inputs.dry_run != true
        run: |
          set -euo pipefail
          ENV="${{ steps.context.outputs.ENV }}"
          S3_ID="${{ steps.context.outputs.S3_ID }}"

          VAR_FILE="s3/generated/${S3_ID}.auto.tfvars.json"

          terraform -chdir=envs/${ENV} apply -auto-approve -input=false -no-color \
            -var-file="${VAR_FILE}"

      - name: Update catalog + audit trail
        if: inputs.dry_run != true
        run: |
          set -euo pipefail
          ENV="${{ steps.context.outputs.ENV }}"
          REGION="${{ steps.backend.outputs.REGION }}"

          python3 scripts/s3_request_parser.py \
            --mode generate \
            --input-files "${{ inputs.request_file }}" \
            --output-root envs \
            --catalog-path "docs/20-contracts/resource-catalogs/s3-catalog.yaml" \
            --catalog-region "${REGION}" \
            --catalog-status "active" \
            --audit-path "governance/${ENV}/s3_request_audit.csv" \
            --audit-action "apply" \
            --audit-status "success" \
            --audit-approver "${{ github.actor }}"

      - name: Commit catalog + audit updates
        if: inputs.dry_run != true
        run: |
          set -euo pipefail
          git config user.name "goldenpath-bot"
          git config user.email "goldenpath-bot@users.noreply.github.com"

          git add docs/20-contracts/resource-catalogs/s3-catalog.yaml || true
          git add governance/**/s3_request_audit.csv || true
          git add envs/**/s3/generated/*.auto.tfvars.json || true
          git add envs/generated/iam/*-s3-policy.json || true

          if git diff --cached --quiet; then
            echo "No catalog/audit changes to commit."
            exit 0
          fi

          git commit -m "chore(s3): update catalog and audit trail [skip ci]"
          git push

      - name: Apply summary
        if: inputs.dry_run != true
        run: |
          echo "## S3 Request Apply" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Request | ${{ inputs.request_file }} |" >> $GITHUB_STEP_SUMMARY
          echo "| S3 ID | ${{ steps.context.outputs.S3_ID }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ steps.context.outputs.ENV }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Bucket | ${{ steps.context.outputs.BUCKET_NAME }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Terraform apply completed successfully." >> $GITHUB_STEP_SUMMARY
