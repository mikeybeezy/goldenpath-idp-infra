name: Determinism Guard

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - development

permissions:
  contents: read
  pull-requests: read

jobs:
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      critical: ${{ steps.filter.outputs.critical }}
      schemas: ${{ steps.filter.outputs.schemas }}
      file_count: ${{ steps.count.outputs.total }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect critical path changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            critical:
              - 'modules/**'
              - 'schemas/**'
              - 'scripts/**'
              - 'bootstrap/**'
              - '.github/workflows/**'
              - 'envs/**/*.tf'
              - 'envs/**/*.tfvars'
            schemas:
              - 'schemas/**/*.yaml'
              - 'schemas/**/*.json'

      - name: Count changed files
        id: count
        run: |
          TOTAL=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | wc -l | tr -d ' ')
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "Changed files: $TOTAL"

      - name: Summary
        run: |
          echo "## Change Detection" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Files changed | ${{ steps.count.outputs.total }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Critical paths | ${{ steps.filter.outputs.critical }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Schema changes | ${{ steps.filter.outputs.schemas }} |" >> $GITHUB_STEP_SUMMARY

  enforce-blast-radius:
    name: Blast Radius Check
    needs: detect-changes
    runs-on: ubuntu-latest
    if: needs.detect-changes.outputs.file_count > 80
    steps:
      - name: Check for override label
        id: check-label
        uses: actions/github-script@v7
        with:
          script: |
            const labels = context.payload.pull_request.labels.map(l => l.name);
            if (labels.includes('blast-radius-approved')) {
              core.setOutput('approved', 'true');
              console.log('Blast radius override approved via label');
            } else {
              core.setOutput('approved', 'false');
            }

      - name: Fail on excessive change
        if: steps.check-label.outputs.approved != 'true'
        run: |
          echo "## Blast Radius Exceeded" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This PR changes **${{ needs.detect-changes.outputs.file_count }}** files (limit: 80)." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Large changes require explicit approval to prevent accidental mass modifications." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Options" >> $GITHUB_STEP_SUMMARY
          echo "1. Add label \`blast-radius-approved\` if this is intentional" >> $GITHUB_STEP_SUMMARY
          echo "2. Split into smaller PRs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "See [ADR-0182: TDD Philosophy](docs/adrs/ADR-0182-tdd-philosophy.md) for guidance." >> $GITHUB_STEP_SUMMARY

          echo ""
          echo " Blast radius exceeded: ${{ needs.detect-changes.outputs.file_count }} files (limit: 80)"
          echo ""
          echo "Add label 'blast-radius-approved' if this change is intentional."
          exit 1

      - name: Approved override
        if: steps.check-label.outputs.approved == 'true'
        run: |
          echo "## Blast Radius Approved" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Large change (${{ needs.detect-changes.outputs.file_count }} files) approved via \`blast-radius-approved\` label." >> $GITHUB_STEP_SUMMARY

          echo "✅ Blast radius override approved"

  tests:
    name: Run Tests
    needs: detect-changes
    runs-on: ubuntu-latest
    if: needs.detect-changes.outputs.critical == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run pytest
        run: |
          pytest tests/ -q --tb=short || true

      - name: Run bats tests
        run: |
          if command -v bats &> /dev/null; then
            bats tests/bats/*.bats || true
          else
            echo "bats not installed, skipping shell tests"
          fi

      - name: Summary
        run: |
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Tests executed for critical path changes." >> $GITHUB_STEP_SUMMARY

  schema-validation:
    name: Validate Schemas
    needs: detect-changes
    runs-on: ubuntu-latest
    if: needs.detect-changes.outputs.schemas == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install schema validator
        run: |
          pip install check-jsonschema pyyaml

      - name: Validate request schemas
        run: |
          echo "Validating request schemas..."
          for schema in schemas/requests/*.schema.yaml; do
            echo "  Checking $schema"
            python -c "import yaml; yaml.safe_load(open('$schema'))" || exit 1
          done
          echo "✅ All request schemas are valid YAML"

      - name: Validate metadata schemas
        run: |
          echo "Validating metadata schemas..."
          for schema in schemas/metadata/*.schema.yaml; do
            echo "  Checking $schema"
            python -c "import yaml; yaml.safe_load(open('$schema'))" || exit 1
          done
          echo "✅ All metadata schemas are valid YAML"

      - name: Summary
        run: |
          echo "## Schema Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All schema files validated successfully." >> $GITHUB_STEP_SUMMARY
