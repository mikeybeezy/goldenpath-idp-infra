# Owner: platform
# Description: Manual workflow to request a new application secret via workflow dispatch, creating a PR with a Terraform plan.
# Relates-To: 85-how-it-works/secrets-flow/SECRET_REQUEST_FLOW.md
name: Request App Secret

on:
  workflow_dispatch:
    inputs:
      base_branch:
        description: 'PR base branch'
        required: true
        default: development
      environment:
        description: 'Target environment'
        type: choice
        required: true
        options: [dev, test, staging, prod]
      service_name:
        description: 'Service name (e.g., payments)'
        required: true
      secret_name:
        description: 'Secret name (e.g., db-credentials)'
        required: true
      secret_type:
        description: 'Secret Classification'
        type: choice
        required: true
        options:
          - generic
          - database-credentials
          - api-key
          - oauth-client
          - webhook-secret
          - signing-key
          - encryption-key
          - tls-private-key
          - container-registry-credential
          - third-party-token
      owner:
        description: 'Team owner'
        type: choice
        required: true
        options:
          - app-team
          - platform-team
          - security-team
          - operations-team
          - sre-team
          - database-team
      domain:
        description: 'Business Domain'
        type: choice
        required: true
        options:
          - platform-core
          - delivery
          - identity
          - catalog
          - observability
          - governance
          - security
          - cost
      risk:
        description: 'Risk level'
        type: choice
        required: true
        options: [low, medium, high]
      rotation:
        description: 'Rotation class'
        type: choice
        required: true
        options: [none, standard, high]
      recovery_window:
        description: 'Recovery Window (days)'
        type: choice
        required: true
        options: ["0", "7", "30"]
        default: "30"
      description:
        description: 'Brief description of the secret'
        required: false
      namespace:
        description: 'K8s Metadata Namespace'
        required: true
        default: default
      k8s_secret_name:
        description: 'K8s Secret Name'
        required: true

permissions:
  contents: write
  pull-requests: write
  id-token: write

jobs:
  propose-secret:
    name: Propose Secret Creation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Calculate Identifiers
        id: calc
        run: |
          # Generate a deterministic ID: SEC-<hash of service/name> or just a counter
          # For simplicity and style, we'll try to find the next SEC-XXXX or use a timestamp
          ID="SEC-$(date +%s | tail -c 5)"
          echo "id=$ID" >> $GITHUB_OUTPUT
          echo "‚úÖ Calculated ID: $ID"

      - name: Create Secret Request YAML
        run: |
          set -euo pipefail
          SERVICE="${{ inputs.service_name }}"
          ENV="${{ inputs.environment }}"
          ID="${{ steps.calc.outputs.id }}"
          DIR="docs/20-contracts/secret-requests/$SERVICE/$ENV"
          mkdir -p "$DIR"

          # Handle optional description
          DESC="${{ inputs.description }}"
          [ -z "$DESC" ] && DESC="Secret for $SERVICE service"

          cat <<EOF > "$DIR/$ID.yaml"
          apiVersion: goldenpath.io/v1
          kind: SecretRequest
          id: $ID
          description: "$DESC"
          owner: ${{ inputs.owner }}
          metadata:
            name: ${{ inputs.secret_name }}
            service: $SERVICE
            environment: $ENV
            domain: ${{ inputs.domain }}
          spec:
            provider: aws-secrets-manager
            secretType: ${{ inputs.secret_type }}
            risk:
              tier: ${{ inputs.risk }}
            rotation:
              rotationClass: ${{ inputs.rotation }}
            lifecycle:
              status: active
              recoveryWindowInDays: ${{ inputs.recovery_window }}
            access:
              namespace: ${{ inputs.namespace }}
              k8sSecretName: ${{ inputs.k8s_secret_name }}
          EOF
          echo "‚úÖ Created Secret Request YAML at $DIR/$ID.yaml"

      - name: Run Parser (Generate)
        run: |
          python scripts/secret_request_parser.py \
            --mode generate \
            --enums schemas/metadata/enums.yaml \
            --input-files docs/20-contracts/secret-requests/${{ inputs.service_name }}/${{ inputs.environment }}/${{ steps.calc.outputs.id }}.yaml

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Configure AWS credentials (for Plan)
        uses: aws-actions/configure-aws-credentials@v4.1.0
        with:
          aws-region: eu-west-2
          role-to-assume: ${{ secrets.TF_AWS_IAM_ROLE_DEV }}

      - name: Terraform Init (Stateless File Swap)
        run: |
          ENV_DIR="envs/${{ inputs.environment }}"
          mv "${ENV_DIR}/backend.tf" "${ENV_DIR}/backend.tf.bak"

          cat <<EOF > "${ENV_DIR}/backend.tf"
          terraform {
            backend "local" {}
          }
          EOF

          terraform -chdir="${ENV_DIR}" init -input=false

      - name: Inline Terraform Plan (Targeted)
        id: plan
        run: |
          ENV_DIR="envs/${{ inputs.environment }}"
          SERVICE="${{ inputs.service_name }}"
          NAME="${{ inputs.secret_name }}"
          ID="${{ steps.calc.outputs.id }}"
          VAR_FILE="secrets/generated/$SERVICE/$ID.auto.tfvars.json"

          echo " Running targeted plan for module.app_secrets[\"$SERVICE-$NAME\"]..."

          terraform -chdir="${ENV_DIR}" plan \
            -target="module.app_secrets[\"$SERVICE-$NAME\"]" \
            -var-file="$VAR_FILE" \
            -lock=false \
            -refresh=false \
            -no-color > plan_output.txt 2>&1 || {
              echo " Plan failed with error:"
              cat plan_output.txt
              exit 1
            }

          cat plan_output.txt

      - name: Generate PR Body
        id: pr_body
        run: |
          cat <<'EOF' > pr_body.txt
          ## üîí App Secret Request: ${{ inputs.service_name }}/${{ inputs.secret_name }}

          **ID:** `${{ steps.calc.outputs.id }}`
          **Environment:** `${{ inputs.environment }}`
          **Service:** `${{ inputs.service_name }}`
          **Secret Name:** `${{ inputs.secret_name }}`
          **Secret Type:** `${{ inputs.secret_type }}`
          **Owner:** `${{ inputs.owner }}`
          **Domain:** `${{ inputs.domain }}`
          **Risk:** `${{ inputs.risk }}`
          **Rotation:** `${{ inputs.rotation }}`
          **Recovery Window:** `${{ inputs.recovery_window }} days`

          > ${{ inputs.description }}

          ---

          ## üõ†Ô∏è Terraform Plan Preview

          <details><summary>Click to view targeted plan</summary>

          ```hcl
          PLAN_CONTENT
          ```
          </details>

          ---

          ## üöÄ Next Steps
          1. Review and Approve this PR.
          2. On **Merge**, the secret will be auto-applied to AWS and synced to K8s via ESO.

          /cc @platform-team
          EOF

          # Inject plan safely (reading from root where it was written)
          sed -i '/PLAN_CONTENT/r plan_output.txt' pr_body.txt
          sed -i 's/PLAN_CONTENT//' pr_body.txt

      - name: Restore Real Backend
        if: always()
        run: |
          ENV_DIR="envs/${{ inputs.environment }}"
          [ -f "${ENV_DIR}/backend.tf.bak" ] && mv "${ENV_DIR}/backend.tf.bak" "${ENV_DIR}/backend.tf"

      - name: Create PR
        uses: peter-evans/create-pull-request@v6
        with:
          base: ${{ inputs.base_branch }}
          branch: "secret/request-${{ inputs.service_name }}-${{ inputs.secret_name }}"
          title: "feat(secrets): create ${{ inputs.service_name }}/${{ inputs.secret_name }} in ${{ inputs.environment }}"
          commit-message: "feat(secrets): add $ID for ${{ inputs.service_name }}"
          body-path: pr_body.txt
          labels: |
            secret-request
            platform-team
            ${{ inputs.environment }}
