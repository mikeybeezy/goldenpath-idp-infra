# Owner: platform
name: Apply - Infra Terraform Apply (staging)

on:
  workflow_dispatch:
    inputs:
      confirm_apply:
        description: "Type 'apply' to confirm staging apply"
        required: true
        default: "cancel"
        type: choice
        options:
          - cancel
          - apply
      lifecycle:
        description: "Lifecycle (ephemeral or persistent)"
        required: true
        default: "ephemeral"
        type: choice
        options:
          - ephemeral
          - persistent
      build_id:
        description: "Build ID (dd-mm-yy-NN)"
        required: false
        type: string
      new_build:
        description: "Confirm a new ephemeral build (required when lifecycle=ephemeral)"
        required: true
        default: false
        type: boolean

jobs:
  apply-staging:
    if: ${{ inputs.confirm_apply == 'apply' }}
    runs-on: ubuntu-latest
    environment: staging
    permissions:
      contents: read
      id-token: write
      actions: read
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Validate lifecycle and build ID
        shell: bash
        run: |
          if [[ "${{ inputs.lifecycle }}" == "ephemeral" ]]; then
            if [[ "${{ inputs.new_build }}" != "true" ]]; then
              echo "new_build must be true when lifecycle=ephemeral" >&2
              exit 1
            fi
            if [[ -z "${{ inputs.build_id }}" ]]; then
              echo "build_id is required when lifecycle=ephemeral" >&2
              exit 1
            fi
            if ! [[ "${{ inputs.build_id }}" =~ ^[0-9]{2}-[0-9]{2}-[0-9]{2}-[0-9]{2}$ ]]; then
              echo "Invalid build_id: '${{ inputs.build_id }}' (expected dd-mm-yy-NN)" >&2
              exit 1
            fi
          else
            if [[ "${{ inputs.new_build }}" == "true" ]]; then
              echo "new_build is only valid for lifecycle=ephemeral" >&2
              exit 1
            fi
            if [[ -n "${{ inputs.build_id }}" ]]; then
              echo "build_id is only valid for lifecycle=ephemeral" >&2
              exit 1
            fi
          fi

      - name: Verify staging plan succeeded for this commit
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const workflowId = "infra-terraform.yml";
            const sha = context.sha;
            const lifecycle = "${{ inputs.lifecycle }}";
            const buildId = "${{ inputs.build_id }}";
            const runs = await github.rest.actions.listWorkflowRuns({
              owner,
              repo,
              workflow_id: workflowId,
              event: "workflow_dispatch",
              per_page: 20
            });
            const match = runs.data.workflow_runs.find(
              run =>
                run.conclusion === "success" &&
                run.head_sha === sha &&
                typeof run.display_title === "string" &&
                run.display_title.includes("env=staging") &&
                run.display_title.includes(`lifecycle=${lifecycle}`) &&
                (lifecycle !== "ephemeral" || run.display_title.includes(`build_id=${buildId}`))
            );
            if (!match) {
              core.setFailed(
                `No successful staging plan run found for ${sha}. Run infra-terraform.yml with env=staging and matching lifecycle/build_id first.`
              );
            } else {
              core.info(`Staging plan run ok: ${match.html_url}`);
            }

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Configure AWS credentials using OIDC (apply role)
        uses: aws-actions/configure-aws-credentials@v4.1.0
        with:
          aws-region: eu-west-2
          role-to-assume: ${{ secrets.TF_AWS_IAM_ROLE_STAGING_APPLY }}

      - name: Resolve state key
        run: |
          if [[ "${{ inputs.lifecycle }}" == "ephemeral" ]]; then
            STATE_KEY="envs/staging/builds/${{ inputs.build_id }}/terraform.tfstate"
          else
            STATE_KEY="envs/staging/terraform.tfstate"
          fi
          echo "STATE_KEY=${STATE_KEY}" >> "${GITHUB_ENV}"
          echo "Resolved STATE_KEY=${STATE_KEY}"

      - name: CI summary (state selection)
        run: |
          echo "Lifecycle=${{ inputs.lifecycle }}"
          echo "BuildId=${{ inputs.build_id }}"
          echo "NewBuild=${{ inputs.new_build }}"
          echo "StateKey=${STATE_KEY}"

      - name: Terraform init (backend)
        run: |
          terraform -chdir=envs/staging init \
            -backend-config="bucket=goldenpath-idp-staging-bucket" \
            -backend-config="key=${STATE_KEY}" \
            -backend-config="region=eu-west-2" \
            -backend-config="dynamodb_table=goldenpath-idp-staging-db" \
            -backend-config="encrypt=true"

      - name: Terraform apply (staging)
        run: |
          var_args=(-var "cluster_lifecycle=${{ inputs.lifecycle }}")
          if [[ "${{ inputs.lifecycle }}" == "ephemeral" ]]; then
            var_args+=(-var "build_id=${{ inputs.build_id }}")
          fi
          terraform -chdir=envs/staging apply -auto-approve -input=false -no-color "${var_args[@]}"
      - name: Runbook link
        if: always()
        run: |
          echo "Runbook: docs/20-contracts/21_CI_ENVIRONMENT_CONTRACT.md" >> "${GITHUB_STEP_SUMMARY}"
