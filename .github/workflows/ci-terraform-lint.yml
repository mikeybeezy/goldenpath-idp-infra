# Owner: platform
name: Quality - Terraform Lint & Test

on:
  pull_request:
    branches:
      - main
    paths:
      - "**/*.tf"
      - "**/*.tfvars"
      - "**/*.tftest.hcl"
  push:
    branches:
      - main
      - development
    paths:
      - "**/*.tf"
      - "**/*.tfvars"
      - "**/*.tftest.hcl"

jobs:
  tflint:
    name: Terraform Lint & Validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Format Check
        id: fmt
        run: terraform fmt -check -recursive
        continue-on-error: false

      - name: Terraform Validate (Modules & Envs)
        run: |
          set -e
          # Find all directories containing *.tf files
          # We skip .terraform (plugins) and .git
          find . -type f -name "*.tf" -not -path "*/.terraform/*" -not -path "*/.git/*" -exec dirname {} \; | sort -u | while read -r dir; do
            echo " Validating: $dir"

            # Use subshell to maintain CWD
            (
              cd "$dir"
              # Init without backend (offline, fast)
              terraform init -backend=false -input=false > /dev/null
              terraform validate
            )
          done

      - name: Runbook link
        if: always()
        run: |
          echo "Runbook: docs/20-contracts/21_CI_ENVIRONMENT_CONTRACT.md" >> "${GITHUB_STEP_SUMMARY}"

  terraform-test:
    name: Terraform Module Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "~> 1.6"  # terraform test requires 1.6+

      - name: Require tests for all modules
        run: |
          set -e
          MISSING_TESTS=()

          for module_dir in modules/*/; do
            # Skip if not a module (no *.tf files)
            if ! compgen -G "${module_dir}*.tf" > /dev/null 2>&1; then
              continue
            fi

            if [[ ! -d "${module_dir}tests" ]] || ! compgen -G "${module_dir}tests/*.tftest.hcl" > /dev/null 2>&1; then
              MISSING_TESTS+=("$module_dir")
            fi
          done

          if [[ ${#MISSING_TESTS[@]} -gt 0 ]]; then
            echo "::error::Missing tests for Terraform modules"
            echo "❌ The following modules are missing tests:" >> "$GITHUB_STEP_SUMMARY"
            for module in "${MISSING_TESTS[@]}"; do
              echo "  - $module"
              echo "  - \`$module\`" >> "$GITHUB_STEP_SUMMARY"
            done
            echo ""
            echo "TDD requires a tests/*.tftest.hcl file for each module."
            echo "See docs/adrs/ADR-0182-tdd-philosophy.md"
            exit 1
          fi

          echo "✅ All Terraform modules have tests"

      - name: Run Terraform Tests
        run: |
          set -e
          FOUND_TESTS=0
          mkdir -p test-results
          : > test-results/terraform-test.jsonl

          # Find all modules with tests directory containing .tftest.hcl files
          for module_dir in modules/*/; do
            if compgen -G "${module_dir}tests/*.tftest.hcl" > /dev/null 2>&1; then
              echo "::group::Testing ${module_dir}"
              FOUND_TESTS=1

              (
                cd "$module_dir"
                terraform init -backend=false -input=false
                terraform test -json | tee "$GITHUB_WORKSPACE/test-results/$(basename "$module_dir")-terraform-test.jsonl"
              )

              cat "$GITHUB_WORKSPACE/test-results/$(basename "$module_dir")-terraform-test.jsonl" >> test-results/terraform-test.jsonl

              echo "::endgroup::"
            fi
          done

          if [ "$FOUND_TESTS" -eq 0 ]; then
            echo "No terraform tests found in modules/*/tests/*.tftest.hcl"
            echo "Add tests to enable module validation"
          fi

      - name: Collect Test Metrics
        if: always()
        run: |
          if [ -s test-results/terraform-test.jsonl ]; then
            python3 scripts/collect_test_metrics.py \
              --repo "${{ github.repository }}" \
              --branch "${{ github.ref_name }}" \
              --commit "${{ github.sha }}" \
              --ci-run-id "${{ github.run_id }}" \
              --terraform-json test-results/terraform-test.jsonl \
              --output test-results/test-metrics.json || \
              echo "Warning: failed to collect terraform test metrics"
          else
            echo "No terraform test JSON found; skipping metrics"
          fi

      - name: Test Summary
        if: always()
        run: |
          echo "## Terraform Module Tests" >> "${GITHUB_STEP_SUMMARY}"
          echo "" >> "${GITHUB_STEP_SUMMARY}"
          echo "Tests are located in \`modules/*/tests/*.tftest.hcl\`" >> "${GITHUB_STEP_SUMMARY}"
          echo "" >> "${GITHUB_STEP_SUMMARY}"
          echo "Run locally with:" >> "${GITHUB_STEP_SUMMARY}"
          echo "\`\`\`bash" >> "${GITHUB_STEP_SUMMARY}"
          echo "cd modules/aws_eks && terraform init && terraform test" >> "${GITHUB_STEP_SUMMARY}"
          echo "\`\`\`" >> "${GITHUB_STEP_SUMMARY}"

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: terraform-test-results
          path: |
            test-results/terraform-test.jsonl
            test-results/test-metrics.json
          retention-days: 30

  record-test-metrics:
    name: Record Test Metrics
    runs-on: ubuntu-latest
    needs: [terraform-test]
    if: github.event_name == 'push'
    permissions:
      contents: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Test Metrics
        uses: actions/download-artifact@v4
        with:
          name: terraform-test-results
          path: test-results

      - name: Record Metrics to Governance Registry
        env:
          GOVERNANCE_REGISTRY_BRANCH: governance-registry
        run: |
          if [ ! -f test-results/test-metrics.json ]; then
            echo "No test-metrics.json found; skipping registry write"
            exit 0
          fi

          ENV_NAME="dev"
          if [ "${{ github.ref_name }}" = "main" ]; then
            ENV_NAME="prod"
          fi

          bash scripts/record-test-metrics.sh "$ENV_NAME" test-results/test-metrics.json
