# Owner: platform
name: Plan - PR Terraform Plan

on:
  pull_request:
    paths:
      - "**/*.tf"
      - "**/*.tfvars"
      - ".github/workflows/pr-terraform-plan.yml"

jobs:
  terraform-plan:
    runs-on: ubuntu-latest
    env:
      ENABLE_TF_K8S_RESOURCES: "false"
      TF_VAR_enable_k8s_resources: "false"
    permissions:
      contents: read
      pull-requests: write
      id-token: write
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Configure AWS credentials using OIDC (read-only)
        uses: aws-actions/configure-aws-credentials@v4.1.0
        with:
          aws-region: eu-west-2
          role-to-assume: ${{ secrets.TF_AWS_IAM_ROLE_DEV }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform fmt (check)
        run: terraform fmt -check -recursive

      - name: Resolve state key
        run: |
          read_top_var() {
            local key="$1"
            awk -F'=' -v k="${key}" '{
              line=$0
              sub(/#.*/,"",line)
              if (line ~ /^[[:space:]]*$/) next
              split(line, parts, "=")
              lhs=parts[1]; gsub(/[[:space:]]/,"",lhs)
              if (lhs==k) {
                val=parts[2]
                sub(/#.*/,"",val)
                gsub(/"/,"",val)
                gsub(/[[:space:]]/,"",val)
                print val
                exit
              }
            }' envs/dev/terraform.tfvars
          }
          cluster_lifecycle="${CLUSTER_LIFECYCLE:-$(read_top_var "cluster_lifecycle")}"
          build_id="${BUILD_ID:-$(read_top_var "build_id")}"
          if [[ -z "${cluster_lifecycle}" ]]; then
            cluster_lifecycle="persistent"
          fi
          if [[ "${cluster_lifecycle}" == "ephemeral" ]]; then
            if [[ -z "${build_id}" ]]; then
              echo "build_id is required when cluster_lifecycle=ephemeral" >&2
              exit 1
            fi
            if ! echo "${build_id}" | grep -Eq '^[0-9]{2}-[0-9]{2}-[0-9]{2}-[0-9]{2}$'; then
              echo "Invalid build_id: ${build_id} (expected dd-mm-yy-NN)" >&2
              exit 1
            fi
            STATE_KEY="envs/dev/builds/${build_id}/terraform.tfstate"
          else
            STATE_KEY="envs/dev/terraform.tfstate"
          fi
          echo "CLUSTER_LIFECYCLE=${cluster_lifecycle}" >> "${GITHUB_ENV}"
          echo "BUILD_ID=${build_id}" >> "${GITHUB_ENV}"
          echo "STATE_KEY=${STATE_KEY}" >> "${GITHUB_ENV}"
          echo "Resolved STATE_KEY=${STATE_KEY}"

      - name: CI summary (state selection)
        run: |
          echo "Lifecycle=${CLUSTER_LIFECYCLE:-unknown}"
          echo "BuildId=${BUILD_ID:-}"
          echo "StateKey=${STATE_KEY}"

      - name: Terraform init (backend)
        run: |
          terraform -chdir=envs/dev init -reconfigure \
            -backend-config="bucket=goldenpath-idp-dev-bucket" \
            -backend-config="key=${STATE_KEY}" \
            -backend-config="region=eu-west-2" \
            -backend-config="dynamodb_table=goldenpath-idp-dev-db-key" \
            -backend-config="encrypt=true"

      - name: Terraform validate
        run: terraform -chdir=envs/dev validate

      - name: Terraform plan
        run: terraform -chdir=envs/dev plan -input=false -lock=false -no-color -refresh=false -out=plan.tfplan

      - name: Render plan
        run: terraform -chdir=envs/dev show -no-color plan.tfplan > plan.txt
      - name: Render plan (json)
        run: terraform -chdir=envs/dev show -json plan.tfplan > plan.json

      - name: Comment plan on PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");
            const plan = fs.readFileSync("plan.txt", "utf8");
            const planJson = JSON.parse(fs.readFileSync("plan.json", "utf8"));
            const escapeHtml = (value) =>
              value
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;");
            const counts = { create: 0, update: 0, delete: 0, read: 0, replace: 0, no_op: 0 };
            const changes = planJson.resource_changes || [];
            for (const change of changes) {
              const actions = change.change.actions;
              if (actions.length === 1) {
                counts[actions[0]] = (counts[actions[0]] || 0) + 1;
              } else if (actions.includes("create") && actions.includes("delete")) {
                counts.replace += 1;
              }
            }
            const truncated = plan.length > 65000;
            const planBody = escapeHtml(plan.substring(0, 65000));
            const body = [
              "## Terraform plan (envs/dev)",
              "",
              "<details>",
              "<summary>Plan summary</summary>",
              "",
              "<pre>",
              `create:  ${counts.create}`,
              `update:  ${counts.update}`,
              `delete:  ${counts.delete}`,
              `replace: ${counts.replace}`,
              `read:    ${counts.read}`,
              `no_op:   ${counts.no_op}`,
              "</pre>",
              "</details>",
              "",
              "<details>",
              `<summary>Full plan${truncated ? " (truncated)" : ""}</summary>`,
              "",
              `<pre>${planBody}</pre>`,
              "</details>",
              "",
              truncated ? "_Truncated to 65k characters._" : ""
            ].join("\\n");

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            const marker = "## Terraform plan (envs/dev)";
            const existing = comments.find(c => c.user.type === "Bot" && c.body.startsWith(marker));
            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }
      - name: Runbook link
        if: always()
        run: |
          {
            echo "Runbook: docs/21_CI_ENVIRONMENT_CONTRACT.md"
            echo "Runbook: docs/39_GOLDEN_PATH_VALIDATION.md"
          } >> "${GITHUB_STEP_SUMMARY}"
