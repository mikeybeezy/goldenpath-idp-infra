name: PR Terraform Plan

on:
  pull_request:
    paths:
      - "**/*.tf"
      - "**/*.tfvars"
      - ".github/workflows/pr-terraform-plan.yml"

jobs:
  terraform-plan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      id-token: write
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Configure AWS credentials using OIDC (read-only)
        uses: aws-actions/configure-aws-credentials@v4.1.0
        with:
          aws-region: eu-west-2
          role-to-assume: ${{ secrets.TF_AWS_IAM_ROLE_DEV }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform fmt (check)
        run: terraform fmt -check -recursive

      - name: Terraform init (no backend)
        run: terraform -chdir=envs/dev init -backend=false

      - name: Terraform validate
        run: terraform -chdir=envs/dev validate

      - name: Terraform plan
        run: terraform -chdir=envs/dev plan -input=false -lock=false -no-color -out=plan.tfplan

      - name: Render plan
        run: terraform -chdir=envs/dev show -no-color plan.tfplan > plan.txt

      - name: Comment plan on PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");
            const plan = fs.readFileSync("plan.txt", "utf8");
            const body = [
              "## Terraform plan (envs/dev)",
              "",
              "```",
              plan.substring(0, 65000),
              "```",
              "",
              "_Truncated to 65k characters if needed._"
            ].join("\\n");

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            const marker = "## Terraform plan (envs/dev)";
            const existing = comments.find(c => c.user.type === "Bot" && c.body.startsWith(marker));

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }
