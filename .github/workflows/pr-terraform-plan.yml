name: PR Terraform Plan

on:
  pull_request:
    paths:
      - "**/*.tf"
      - "**/*.tfvars"
      - ".github/workflows/pr-terraform-plan.yml"

jobs:
  terraform-plan:
    runs-on: ubuntu-latest
    env:
      ENABLE_TF_K8S_RESOURCES: "false"
    permissions:
      contents: read
      pull-requests: write
      id-token: write
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Configure AWS credentials using OIDC (read-only)
        uses: aws-actions/configure-aws-credentials@v4.1.0
        with:
          aws-region: eu-west-2
          role-to-assume: ${{ secrets.TF_AWS_IAM_ROLE_DEV }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform fmt (check)
        run: terraform fmt -check -recursive

      - name: Terraform init (backend)
        run: |
          terraform -chdir=envs/dev init -reconfigure \
            -backend-config="bucket=goldenpath-idp-dev-bucket" \
            -backend-config="key=envs/dev/terraform.tfstate" \
            -backend-config="region=eu-west-2" \
            -backend-config="dynamodb_table=goldenpath-idp-dev-db-key" \
            -backend-config="encrypt=true"

      - name: Terraform validate
        run: terraform -chdir=envs/dev validate

      - name: Terraform plan
        run: terraform -chdir=envs/dev plan -input=false -lock=false -no-color -out=plan.tfplan

      - name: Render plan
        run: terraform -chdir=envs/dev show -no-color plan.tfplan > plan.txt
      - name: Render plan (json)
        run: terraform -chdir=envs/dev show -json plan.tfplan > plan.json

      - name: Comment plan on PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");
            const plan = fs.readFileSync("plan.txt", "utf8");
            const planJson = JSON.parse(fs.readFileSync("plan.json", "utf8"));
            const counts = { create: 0, update: 0, delete: 0, read: 0, replace: 0, no_op: 0 };
            const changes = planJson.resource_changes || [];
            for (const change of changes) {
              const actions = change.change.actions;
              if (actions.length === 1) {
                counts[actions[0]] = (counts[actions[0]] || 0) + 1;
              } else if (actions.includes("create") && actions.includes("delete")) {
                counts.replace += 1;
              }
            }
            const body = [
              "## Terraform plan (envs/dev)",
              "",
              "<details>",
              "<summary>Plan summary</summary>",
              "",
              "```text",
              `create:  ${counts.create}`,
              `update:  ${counts.update}`,
              `delete:  ${counts.delete}`,
              `replace: ${counts.replace}`,
              `read:    ${counts.read}`,
              `no_op:   ${counts.no_op}`,
              "```",
              "</details>",
              "",
              "<details>",
              "<summary>Full plan (expand)</summary>",
              "",
              "```text",
              plan.substring(0, 65000),
              "```",
              "</details>",
              "",
              "_Truncated to 65k characters if needed._"
            ].join("\\n");

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            const marker = "## Terraform plan (envs/dev)";
            const existing = comments.find(c => c.user.type === "Bot" && c.body.startsWith(marker));

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }
