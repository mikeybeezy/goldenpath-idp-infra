name: Infra Terraform Apply (dev)

on:
  workflow_dispatch:
    inputs:
      confirm_apply:
        description: "Type 'apply' to confirm dev apply"
        required: true
        default: "cancel"
        type: choice
        options:
          - cancel
          - apply

jobs:
  apply-dev:
    if: ${{ inputs.confirm_apply == 'apply' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      actions: read
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Verify plan workflow succeeded for this commit
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const workflowId = "infra-terraform.yml";
            const sha = context.sha;
            const runs = await github.rest.actions.listWorkflowRuns({
              owner,
              repo,
              workflow_id: workflowId,
              event: "workflow_dispatch",
              per_page: 20
            });
            const match = runs.data.workflow_runs.find(
              run => run.head_sha === sha && run.conclusion === "success"
            );
            if (!match) {
              core.setFailed(
                `No successful plan run found for ${workflowId} on ${sha}. Run plan first.`
              );
            } else {
              core.info(`Plan run ok: ${match.html_url}`);
            }

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Configure AWS credentials using OIDC (apply role)
        uses: aws-actions/configure-aws-credentials@v4.1.0
        with:
          aws-region: eu-west-2
          role-to-assume: ${{ secrets.TF_AWS_IAM_ROLE_DEV_APPLY }}

      - name: Terraform init (backend)
        run: |
          terraform -chdir=envs/dev init \
            -backend-config="bucket=goldenpath-idp-dev-bucket" \
            -backend-config="key=envs/dev/terraform.tfstate" \
            -backend-config="region=eu-west-2" \
            -backend-config="dynamodb_table=goldenpath-idp-dev-db-key" \
            -backend-config="encrypt=true"

      - name: Terraform apply (dev)
        run: terraform -chdir=envs/dev apply -auto-approve -input=false -no-color
