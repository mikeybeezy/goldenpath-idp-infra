# Owner: platform
name: Apply - Infra Terraform Apply (dev)

on:
  workflow_dispatch:
    inputs:
      confirm_apply:
        description: "Type 'apply' to confirm dev apply"
        required: true
        default: "cancel"
        type: choice
        options:
          - cancel
          - apply
      lifecycle:
        description: "Lifecycle (ephemeral or persistent)"
        required: true
        default: "ephemeral"
        type: choice
        options:
          - ephemeral
          - persistent
      build_id:
        description: "Build ID (dd-mm-yy-NN)"
        required: false
        type: string
      new_build:
        description: "Confirm a new ephemeral build (required when lifecycle=ephemeral)"
        required: true
        default: false
        type: boolean

jobs:
  apply-dev:
    if: ${{ inputs.confirm_apply == 'apply' }}
    runs-on: ubuntu-latest
    environment: dev
    outputs:
      apply_duration: ${{ steps.timed_apply.outputs.duration }}
      error_message: ${{ steps.timed_apply.outputs.error_message }}
    permissions:
      contents: read
      id-token: write
      actions: read
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Validate lifecycle and build ID
        shell: bash
        run: |
          if [[ "${{ inputs.lifecycle }}" == "ephemeral" ]]; then
            if [[ "${{ inputs.new_build }}" != "true" ]]; then
              echo "new_build must be true when lifecycle=ephemeral" >&2
              exit 1
            fi
            if [[ -z "${{ inputs.build_id }}" ]]; then
              echo "build_id is required when lifecycle=ephemeral" >&2
              exit 1
            fi
            if ! [[ "${{ inputs.build_id }}" =~ ^[0-9]{2}-[0-9]{2}-[0-9]{2}-[0-9]{2}$ ]]; then
              echo "Invalid build_id: '${{ inputs.build_id }}' (expected dd-mm-yy-NN)" >&2
              exit 1
            fi
          else
            if [[ "${{ inputs.new_build }}" == "true" ]]; then
              echo "new_build is only valid for lifecycle=ephemeral" >&2
              exit 1
            fi
            if [[ -n "${{ inputs.build_id }}" ]]; then
              echo "build_id is only valid for lifecycle=ephemeral" >&2
              exit 1
            fi
          fi

      - name: Verify dev plan succeeded for this commit
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const sha = context.sha;
            const lifecycle = "${{ inputs.lifecycle }}";
            const buildId = "${{ inputs.build_id }}";
            const findManualPlan = async (targetSha) => {
              const manualRuns = await github.rest.actions.listWorkflowRuns({
                owner,
                repo,
                workflow_id: "infra-terraform.yml",
                event: "workflow_dispatch",
                per_page: 50
              });
              return manualRuns.data.workflow_runs.find(
                run =>
                  run.conclusion === "success" &&
                  run.head_sha === targetSha &&
                  typeof run.display_title === "string" &&
                  run.display_title.includes("env=dev") &&
                  run.display_title.includes(`lifecycle=${lifecycle}`) &&
                  (lifecycle !== "ephemeral" || run.display_title.includes(`build_id=${buildId}`))
              );
            };
            const findPrPlan = async (targetSha) => {
              const prRuns = await github.rest.actions.listWorkflowRuns({
                owner,
                repo,
                workflow_id: "pr-terraform-plan.yml",
                event: "pull_request",
                per_page: 50
              });
              return prRuns.data.workflow_runs.find(
                run => run.conclusion === "success" && run.head_sha === targetSha
              );
            };

            const manualMatch = await findManualPlan(sha);
            let prMatch = await findPrPlan(sha);
            let prHeadSha = null;

            if (!prMatch) {
              const prs = await github.rest.repos.listPullRequestsAssociatedWithCommit({
                owner,
                repo,
                commit_sha: sha,
                per_page: 10,
                mediaType: { previews: ["groot"] }
              });
              const merged = prs.data.find(pr => pr.merged_at);
              if (merged) {
                prHeadSha = merged.head.sha;
                prMatch = await findPrPlan(prHeadSha);
              }
            }

            if (!manualMatch && !prMatch) {
              core.setFailed(
                `No successful dev plan run found for ${sha}. Run PR Terraform Plan (matching the PR head) or infra-terraform.yml with env=dev and matching lifecycle/build_id first.`
              );
            } else if (manualMatch) {
              core.info(`Dev plan run ok (manual): ${manualMatch.html_url}`);
            } else if (prHeadSha) {
              core.info(`Dev plan run ok (PR head ${prHeadSha}): ${prMatch.html_url}`);
            } else {
              core.info(`Dev plan run ok (PR): ${prMatch.html_url}`);
            }

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Configure AWS credentials using OIDC (apply role)
        uses: aws-actions/configure-aws-credentials@v4.1.0
        with:
          aws-region: eu-west-2
          role-to-assume: ${{ secrets.TF_AWS_IAM_ROLE_DEV_APPLY }}

      - name: Resolve state key
        run: |
          if [[ "${{ inputs.lifecycle }}" == "ephemeral" ]]; then
            STATE_KEY="envs/dev/builds/${{ inputs.build_id }}/terraform.tfstate"
          else
            STATE_KEY="envs/dev/terraform.tfstate"
          fi
          echo "STATE_KEY=${STATE_KEY}" >> "${GITHUB_ENV}"
          echo "Resolved STATE_KEY=${STATE_KEY}"

      - name: CI summary (state selection)
        run: |
          echo "Lifecycle=${{ inputs.lifecycle }}"
          echo "BuildId=${{ inputs.build_id }}"
          echo "NewBuild=${{ inputs.new_build }}"
          echo "StateKey=${STATE_KEY}"

      - name: Terraform init (backend)
        run: |
          terraform -chdir=envs/dev init \
            -backend-config="bucket=goldenpath-idp-dev-bucket" \
            -backend-config="key=${STATE_KEY}" \
            -backend-config="region=eu-west-2" \
            -backend-config="dynamodb_table=goldenpath-idp-dev-db-key" \
            -backend-config="encrypt=true"

      - name: DEBUG - Manual EKS Access Setup
        run: |
          # 1. Get Current Runner ARN
          RUNNER_ARN=$(aws sts get-caller-identity --query Arn --output text)
          echo "Runnner ARN: $RUNNER_ARN"

          # 2. Create Access Entry (Ignore if exists)
          echo "Creating Access Entry..."
          aws eks create-access-entry \
            --cluster-name goldenpath-dev-eks-${{ inputs.build_id }} \
            --principal-arn "$RUNNER_ARN" \
            --region eu-west-2 || true

          # 3. Associate Policy (Ignore if exists)
          echo "Associating Policy..."
          aws eks associate-access-policy \
            --cluster-name goldenpath-dev-eks-${{ inputs.build_id }} \
            --principal-arn "$RUNNER_ARN" \
            --policy-arn arn:aws:eks::aws:cluster-access-policy/AmazonEKSClusterAdminPolicy \
            --access-scope type=cluster \
            --region eu-west-2 || true

          # 4. Update Kubeconfig & Verify
          echo "Verifying Connectivity..."
          aws eks update-kubeconfig --name goldenpath-dev-eks-${{ inputs.build_id }} --region eu-west-2 || true
          kubectl get ns || true
          kubectl get pods -A || true

      - name: Terraform apply (dev)
        id: timed_apply
        run: |
          start_epoch=$(date -u +%s)
          var_args=(-var "cluster_lifecycle=${{ inputs.lifecycle }}")
          if [[ "${{ inputs.lifecycle }}" == "ephemeral" ]]; then
            var_args+=(-var "build_id=${{ inputs.build_id }}")
          fi
          set +e
          terraform -chdir=envs/dev apply -auto-approve -input=false -no-color "${var_args[@]}" 2>&1 | tee apply.log
          status=${PIPESTATUS[0]}
          end_epoch=$(date -u +%s)
          duration=$((end_epoch - start_epoch))
          echo "duration=${duration}" >> "$GITHUB_OUTPUT"
          if [[ $status -ne 0 ]]; then
            error_msg=$(tail -n 20 apply.log | tr '\n' ' ' | sed 's/"/\\"/g')
            echo "error_message=${error_msg}" >> "$GITHUB_OUTPUT"
            exit $status
          fi
      - name: Runbook link
        if: always()
        run: |
          echo "Runbook: docs/20-contracts/21_CI_ENVIRONMENT_CONTRACT.md" >> "${GITHUB_STEP_SUMMARY}"

  log-generation:
    runs-on: ubuntu-latest
    needs: apply-dev
    if: ${{ always() && inputs.build_id != '' }}
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Determine Outcome
        id: outcome
        run: |
          if [[ "${{ needs.apply-dev.result }}" == "success" ]]; then
            echo "outcome=Success" >> "$GITHUB_OUTPUT"
          else
            echo "outcome=Failure" >> "$GITHUB_OUTPUT"
          fi

      - name: Generate Build Log
        if: ${{ needs.apply-dev.result == 'success' || needs.apply-dev.result == 'failure' }}
        id: generate
        run: |
          ./scripts/generate-build-log.sh \
            "${{ inputs.build_id }}" \
            "${{ needs.apply-dev.outputs.apply_duration }}" \
            "-" \
            "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            "${{ steps.outcome.outputs.outcome }}" \
            "LIFECYCLE=${{ inputs.lifecycle }} NEW_BUILD=${{ inputs.new_build }}" \
            "${{ needs.apply-dev.outputs.error_message }}"

      - name: Create or Update Log PR
        if: ${{ steps.generate.outcome == 'success' }}
        continue-on-error: true
        uses: peter-evans/create-pull-request@v6
        with:
          branch: automation/build-run-logs
          base: development
          delete-branch: false
          commit-message: "docs: auto-generate build log for build ${{ inputs.build_id }}"
          title: "docs: update build-run logs (build ${{ inputs.build_id }})"
          body: |
            Select at least one checkbox per section by changing `[ ]` to `[x]`.

            ## Change Type
            - [ ] Feature
            - [ ] Bug fix
            - [ ] Infra change
            - [x] Governance / Policy

            ## Decision Impact
            - [ ] Requires ADR
            - [ ] Updates existing ADR
            - [x] No architectural impact

            ## Production Readiness
            - [ ] Readiness checklist completed
            - [x] No production impact

            ## Testing / Validation
            - [ ] Plan/apply link provided (paste below)
            - [ ] Test command or run ID provided (paste below)
            - [x] Not applicable

            Testing/Validation details:
            - Plan/apply link:
            - Test command/run:

            ## Risk & Rollback
            - [ ] Rollback plan documented (link or notes below)
            - [ ] Data migration required
            - [ ] No data migration
            - [x] Not applicable

            Rollback notes/link:

            ## Notes / Summary (optional)
            - Automated build-run log capture from dev apply.
