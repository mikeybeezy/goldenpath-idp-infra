# Owner: platform
name: Ops - Secret Rotation Compliance Check

# Scheduled daily check for secret rotation compliance
# Alerts when platform RDS secrets are approaching rotation deadline
#
# ADR Reference: ADR-0158-platform-standalone-rds-bounded-context.md
# Runbook: docs/70-operations/runbooks/RB-0029-rds-manual-secret-rotation.md

on:
  schedule:
    # Run daily at 06:00 UTC (before work hours in most timezones)
    - cron: "0 6 * * *"
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to check (dev/staging/prod or all)"
        required: true
        default: "all"
        type: choice
        options:
          - all
          - dev
          - staging
          - prod
      warning_threshold_days:
        description: "Days before rotation deadline to warn"
        required: false
        default: "5"
        type: string

env:
  # Default thresholds (can be overridden per environment)
  DEFAULT_ROTATION_DAYS: 30
  DEFAULT_WARNING_THRESHOLD: 5

jobs:
  check-secret-rotation:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      issues: write
    strategy:
      fail-fast: false
      matrix:
        environment:
          - name: dev
            rotation_days: 30
            role_secret: TF_AWS_IAM_ROLE_DEV_APPLY
          - name: staging
            rotation_days: 14
            role_secret: TF_AWS_IAM_ROLE_STAGING
          - name: prod
            rotation_days: 14
            role_secret: TF_AWS_IAM_ROLE_PROD
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Check if environment should be checked
        id: should_run
        run: |
          INPUT_ENV="${{ github.event.inputs.environment || 'all' }}"
          MATRIX_ENV="${{ matrix.environment.name }}"
          if [[ "${INPUT_ENV}" == "all" || "${INPUT_ENV}" == "${MATRIX_ENV}" ]]; then
            echo "skip=false" >> "${GITHUB_OUTPUT}"
          else
            echo "skip=true" >> "${GITHUB_OUTPUT}"
          fi

      - name: Configure AWS credentials using OIDC
        if: steps.should_run.outputs.skip == 'false'
        uses: aws-actions/configure-aws-credentials@v4.1.0
        with:
          aws-region: eu-west-2
          role-to-assume: ${{ secrets[matrix.environment.role_secret] }}

      - name: Check secret ages
        if: steps.should_run.outputs.skip == 'false'
        id: check
        env:
          ENVIRONMENT: ${{ matrix.environment.name }}
          ROTATION_DAYS: ${{ matrix.environment.rotation_days }}
          WARNING_THRESHOLD: ${{ github.event.inputs.warning_threshold_days || env.DEFAULT_WARNING_THRESHOLD }}
        run: |
          set -euo pipefail

          echo "Checking secret rotation compliance for ${ENVIRONMENT}..."

          # Secret paths to check
          SECRET_PREFIXES=(
            "goldenpath/${ENVIRONMENT}/rds/master"
            "goldenpath/${ENVIRONMENT}/keycloak/postgres"
            "goldenpath/${ENVIRONMENT}/backstage/postgres"
          )

          WARNINGS=""
          CRITICAL=""
          COMPLIANT=""

          for SECRET_PATH in "${SECRET_PREFIXES[@]}"; do
            # Get secret metadata
            if ! SECRET_INFO=$(aws secretsmanager describe-secret --secret-id "${SECRET_PATH}" 2>/dev/null); then
              echo "Secret not found: ${SECRET_PATH} (may not exist yet)"
              continue
            fi

            # Get last changed date
            LAST_CHANGED=$(echo "${SECRET_INFO}" | jq -r '.LastChangedDate // .CreatedDate // empty')
            if [[ -z "${LAST_CHANGED}" ]]; then
              echo "Could not determine age for: ${SECRET_PATH}"
              continue
            fi

            # Calculate age in days
            LAST_CHANGED_EPOCH=$(date -d "${LAST_CHANGED}" +%s 2>/dev/null || date -j -f "%Y-%m-%dT%H:%M:%S" "${LAST_CHANGED%%.*}" +%s 2>/dev/null || echo "0")
            NOW_EPOCH=$(date +%s)
            AGE_DAYS=$(( (NOW_EPOCH - LAST_CHANGED_EPOCH) / 86400 ))

            # Determine status
            DEADLINE_DAYS=$((ROTATION_DAYS - AGE_DAYS))
            WARNING_DAYS=$((WARNING_THRESHOLD))

            if [[ "${AGE_DAYS}" -ge "${ROTATION_DAYS}" ]]; then
              CRITICAL="${CRITICAL}\n- ${SECRET_PATH}: ${AGE_DAYS} days old (OVERDUE by $((AGE_DAYS - ROTATION_DAYS)) days)"
            elif [[ "${DEADLINE_DAYS}" -le "${WARNING_DAYS}" ]]; then
              WARNINGS="${WARNINGS}\n- ${SECRET_PATH}: ${AGE_DAYS} days old (due in ${DEADLINE_DAYS} days)"
            else
              COMPLIANT="${COMPLIANT}\n- ${SECRET_PATH}: ${AGE_DAYS} days old (${DEADLINE_DAYS} days until rotation)"
            fi
          done

          # Set outputs
          if [[ -n "${CRITICAL}" ]]; then
            echo "status=critical" >> "${GITHUB_OUTPUT}"
            echo "critical<<EOF" >> "${GITHUB_OUTPUT}"
            echo -e "${CRITICAL}" >> "${GITHUB_OUTPUT}"
            echo "EOF" >> "${GITHUB_OUTPUT}"
          elif [[ -n "${WARNINGS}" ]]; then
            echo "status=warning" >> "${GITHUB_OUTPUT}"
          else
            echo "status=compliant" >> "${GITHUB_OUTPUT}"
          fi

          echo "warnings<<EOF" >> "${GITHUB_OUTPUT}"
          echo -e "${WARNINGS}" >> "${GITHUB_OUTPUT}"
          echo "EOF" >> "${GITHUB_OUTPUT}"

          echo "compliant<<EOF" >> "${GITHUB_OUTPUT}"
          echo -e "${COMPLIANT}" >> "${GITHUB_OUTPUT}"
          echo "EOF" >> "${GITHUB_OUTPUT}"

      - name: Generate summary
        if: steps.should_run.outputs.skip == 'false'
        run: |
          {
            echo "## Secret Rotation Check: ${{ matrix.environment.name }}"
            echo ""
            echo "**Status:** ${{ steps.check.outputs.status || 'skipped' }}"
            echo "**Rotation Policy:** ${{ matrix.environment.rotation_days }} days"
            echo ""

            if [[ "${{ steps.check.outputs.status }}" == "critical" ]]; then
              echo "### CRITICAL - Secrets Overdue for Rotation"
              echo "${{ steps.check.outputs.critical }}"
              echo ""
            fi

            if [[ -n "${{ steps.check.outputs.warnings }}" ]]; then
              echo "### Warnings - Approaching Rotation Deadline"
              echo "${{ steps.check.outputs.warnings }}"
              echo ""
            fi

            if [[ -n "${{ steps.check.outputs.compliant }}" ]]; then
              echo "### Compliant"
              echo "${{ steps.check.outputs.compliant }}"
              echo ""
            fi

            echo "---"
            echo "**Runbook:** [RB-0029 Manual Secret Rotation](docs/70-operations/runbooks/RB-0029-rds-manual-secret-rotation.md)"
          } >> "${GITHUB_STEP_SUMMARY}"

      - name: Create issue if critical
        if: steps.should_run.outputs.skip == 'false' && steps.check.outputs.status == 'critical'
        uses: actions/github-script@v7
        with:
          script: |
            const env = '${{ matrix.environment.name }}';
            const title = `[URGENT] Secret Rotation Overdue - ${env}`;
            const body = `## Secret Rotation Compliance Alert

            **Environment:** ${env}
            **Status:** CRITICAL - Secrets are overdue for rotation

            ### Overdue Secrets
            ${{ steps.check.outputs.critical }}

            ### Action Required
            1. Follow [RB-0029 Manual Secret Rotation](docs/70-operations/runbooks/RB-0029-rds-manual-secret-rotation.md)
            2. Rotate all overdue secrets immediately
            3. Update the secrets in AWS Secrets Manager

            ### Why This Matters
            - Stale credentials increase security risk
            - Compliance requirements mandate regular rotation
            - Applications may fail if secrets expire

            ---
            *This issue was automatically created by the secret-rotation-check workflow.*
            `;

            // Check for existing open issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'secret-rotation,critical'
            });

            const existingIssue = issues.data.find(i => i.title.includes(env));

            if (existingIssue) {
              // Update existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `## Daily Check Update\n\n${body}`
              });
              console.log(`Updated existing issue #${existingIssue.number}`);
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['secret-rotation', 'critical', 'security', 'platform']
              });
              console.log('Created new issue for overdue secrets');
            }

  summary:
    needs: check-secret-rotation
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Final summary
        run: |
          {
            echo "## Secret Rotation Compliance - All Environments"
            echo ""
            echo "| Environment | Status |"
            echo "|-------------|--------|"
            echo "| dev | ${{ needs.check-secret-rotation.result }} |"
            echo "| staging | ${{ needs.check-secret-rotation.result }} |"
            echo "| prod | ${{ needs.check-secret-rotation.result }} |"
            echo ""
            echo "---"
            echo "Run manually: \`gh workflow run secret-rotation-check.yml -f environment=all\`"
          } >> "${GITHUB_STEP_SUMMARY}"
