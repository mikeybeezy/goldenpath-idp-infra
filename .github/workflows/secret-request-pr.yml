# Owner: platform
# Relates-To: how-it-works/SECRET_REQUEST_FLOW.md
name: Policy - Secret Request Validation

on:
  pull_request:
    paths:
      - 'catalogs/secrets/**'

permissions:
  contents: read
  pull-requests: write

jobs:
  validate:
    name: Validate Secret Request
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install pyyaml

      - name: Run Schema Validation
        run: |
          # Use the generic metadata validator which now supports SecretRequest schema
          python3 scripts/validate_metadata.py catalogs/secrets/

      - name: Policy Gate (Risk vs Rotation)
        run: |
          python3 -c '
          import yaml
          import os
          import sys

          failed = False
          for root, _, files in os.walk("catalogs/secrets/"):
              for f in files:
                  if f.endswith(".yaml"):
                      path = os.path.join(root, f)
                      with open(path) as stream:
                          data = yaml.safe_load(stream)
                          spec = data.get("spec", {})
                          risk = spec.get("riskTier")
                          rotation = spec.get("rotationClass")
                          
                          if risk == "high" and rotation == "none":
                              print(f"‚ùå POLICY VIOLATION in {path}: High risk secrets MUST have rotation enabled.")
                              failed = True
          if failed: sys.exit(1)
          '

      - name: Terraform Plan (Targeted)
        # Note: In a real environment, this would use a service role and run terraform plan
        # For this demonstration, we'll log the intention.
        run: |
          echo "üîç Detecting changed secrets..."
          # Logic to find changed secrets and run 'terraform plan -target=module.app_secrets[\"name\"]'
          echo "‚úÖ Plan simulation passed."
