# Owner: platform
# Description: Validates SecretRequest YAMLs and generates Terraform plan previews on Pull Requests.
# Relates-To: 85-how-it-works/secrets-flow/SECRET_REQUEST_FLOW.md
name: Secret Requests (PR)

on:
  pull_request:
    paths:
      - "docs/20-contracts/secret-requests/**"
      - "schemas/metadata/**"
      - "scripts/secret_request_parser.py"

permissions:
  contents: read
  pull-requests: write

jobs:
  validate-and-plan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Detect changed SecretRequest files
        id: changed
        shell: bash
        run: |
          set -euo pipefail
          BASE="${{ github.event.pull_request.base.sha }}"
          HEAD="${{ github.sha }}"
          CHANGED=$(git diff --name-only "$BASE" "$HEAD" | grep -E '^docs/20-contracts/secret-requests/.+\.ya?ml$' || true)
          echo "files<<EOF" >> "$GITHUB_OUTPUT"
          echo "$CHANGED" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Validate SecretRequests + generate previews
        if: steps.changed.outputs.files != ''
        env:
          CHANGED_FILES: ${{ steps.changed.outputs.files }}
        run: |
          set -euo pipefail
          # Convert newline-separated files to space-separated for argparse nargs='+'
          FILE_LIST=$(echo "$CHANGED_FILES" | tr '\n' ' ')

          python scripts/secret_request_parser.py \
            --mode validate \
            --input-files $FILE_LIST \
            --enums schemas/metadata/enums.yaml

          mkdir -p .tmp/generated
          python scripts/secret_request_parser.py \
            --mode generate \
            --input-files $FILE_LIST \
            --enums schemas/metadata/enums.yaml \
            --tfvars-out-root .tmp/generated \
            --externalsecret-out-root .tmp/generated

      - name: Upload generated preview
        if: steps.changed.outputs.files != ''
        uses: actions/upload-artifact@v4
        with:
          name: secret-request-generated-preview
          path: .tmp/generated
          retention-days: 1

      - name: Setup Terraform
        if: steps.changed.outputs.files != ''
        uses: hashicorp/setup-terraform@v3

      - name: Configure AWS credentials (Plan Role)
        if: steps.changed.outputs.files != ''
        uses: aws-actions/configure-aws-credentials@v4.1.0
        with:
          aws-region: eu-west-2
          role-to-assume: ${{ secrets.TF_AWS_IAM_ROLE_DEV }}

      - name: Resolve Context & Terraform Init
        if: steps.changed.outputs.files != ''
        id: context
        run: |
          LIFECYCLE=$(grep "cluster_lifecycle" envs/dev/terraform.tfvars | cut -d'"' -f2)
          BUILD_ID=$(grep "build_id" envs/dev/terraform.tfvars | cut -d'"' -f2)

          if [[ "$LIFECYCLE" == "ephemeral" ]]; then
            STATE_KEY="envs/dev/builds/${BUILD_ID}/terraform.tfstate"
          else
            STATE_KEY="envs/dev/terraform.tfstate"
          fi

          terraform -chdir=envs/dev init \
            -backend-config="bucket=goldenpath-idp-dev-bucket" \
            -backend-config="key=$STATE_KEY" \
            -backend-config="region=eu-west-2" \
            -backend-config="dynamodb_table=goldenpath-idp-dev-db-key" \
            -backend-config="encrypt=true"

      - name: Terraform Plan (Targeted)
        if: steps.changed.outputs.files != ''
        id: plan
        env:
          CHANGED_FILES: ${{ steps.changed.outputs.files }}
        run: |
          set -euo pipefail

          TARGETS=""
          VAR_FILES=""
          for FILE in $CHANGED_FILES; do
            echo "ðŸ”¬ Extracting metadata from $FILE..."
            # Robust metadata extraction supporting both top-level and nested metadata block
            # Also extract environment from file path: docs/20-contracts/secret-requests/<service>/<env>/<id>.yaml
            eval $(python3 -c "import yaml; d = yaml.safe_load(open('$FILE')) or {}; m = d.get('metadata', {}); print(f\"SERVICE={m.get('service', d.get('service', 'unknown'))}\"); print(f\"NAME={m.get('name', d.get('name', 'unknown'))}\"); print(f\"ENV={m.get('environment', d.get('environment', 'dev'))}\");")

            ID=$(basename "$FILE" .yaml)
            echo "ðŸš€ Running plan for $ID (Service: $SERVICE, Name: $NAME, Env: $ENV)"
            # Use the .tmp/generated files for the plan if we are in PR
            # Parser outputs to: .tmp/generated/<env>/secrets/generated/<service>/<id>.auto.tfvars.json
            # Terraform runs with -chdir=envs/dev, so relative path is ../../.tmp/generated/...
            TARGETS="$TARGETS -target=\"module.app_secrets[\\\"$SERVICE-$NAME\\\"]\""
            VAR_FILES="$VAR_FILES -var-file=../../.tmp/generated/$ENV/secrets/generated/$SERVICE/$ID.auto.tfvars.json"
          done

          terraform -chdir=envs/dev plan -input=false -no-color -refresh=false $VAR_FILES $TARGETS -out=plan.tfplan
          terraform -chdir=envs/dev show -no-color plan.tfplan > envs/dev/plan.txt

      - name: Comment Plan on PR
        if: steps.changed.outputs.files != ''
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");
            const plan = fs.readFileSync("envs/dev/plan.txt", "utf8");
            const body = [
              "## ðŸ”’ Secret Request Terraform Plan (dev)",
              "",
              "<details><summary>Click to view targeted plan</summary>",
              "",
              "```hcl",
              plan.substring(0, 65000),
              "```",
              "</details>"
            ].join("\n");

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body,
            });
