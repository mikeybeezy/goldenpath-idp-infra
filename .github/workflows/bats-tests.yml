# Bats Shell Script Tests
# Runs bats-core tests for shell scripts
# Part of TDD infrastructure (GOV-0016, GOV-0017)

name: Shell Script Tests (bats)

on:
  push:
    branches: [main, development]
    paths:
      - '**.sh'
      - 'tests/bats/**'
      - '.github/workflows/bats-tests.yml'
  pull_request:
    branches: [main, development]
    paths:
      - '**.sh'
      - 'tests/bats/**'
      - '.github/workflows/bats-tests.yml'

jobs:
  bats:
    name: Bats Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install bats-core
        run: |
          sudo apt-get update
          sudo apt-get install -y bats

      - name: Run bats tests
        id: bats
        run: |
          echo "Running bats tests..."
          bats tests/bats/*.bats --formatter tap | tee bats-results.tap
        continue-on-error: true

      - name: Convert TAP to JUnit
        if: always()
        run: |
          # Install tap-junit converter
          npm install -g tap-junit

          # Convert TAP to JUnit XML
          cat bats-results.tap | tap-junit > bats-junit.xml || true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bats-test-results
          path: |
            bats-results.tap
            bats-junit.xml
          retention-days: 30

      - name: Test Summary
        if: always()
        run: |
          echo "### Bats Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Count results from TAP output
          PASSED=$(grep -c "^ok" bats-results.tap || echo "0")
          FAILED=$(grep -c "^not ok" bats-results.tap || echo "0")
          TOTAL=$((PASSED + FAILED))

          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Passed | $PASSED |" >> $GITHUB_STEP_SUMMARY
          echo "| Failed | $FAILED |" >> $GITHUB_STEP_SUMMARY
          echo "| Total | $TOTAL |" >> $GITHUB_STEP_SUMMARY

          if [[ "$FAILED" -gt 0 ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Status**: Some tests failed" >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Status**: All tests passed" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fail if tests failed
        if: steps.bats.outcome == 'failure'
        run: exit 1

  shellcheck:
    name: ShellCheck Lint
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run ShellCheck
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: './scripts'
          severity: warning
        continue-on-error: true

      - name: ShellCheck bootstrap scripts
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: './bootstrap'
          severity: warning
        continue-on-error: true
