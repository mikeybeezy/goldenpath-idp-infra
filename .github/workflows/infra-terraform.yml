# Owner: platform
name: Plan - Infra Terraform Checks
run-name: "infra-plan (env=${{ inputs.env }}, lifecycle=${{ inputs.lifecycle }}, build_id=${{ inputs.build_id }})"

on:
  workflow_dispatch:
    inputs:
      env:
        description: "Environment to plan (dev/test/staging/prod)"
        required: true
        default: "dev"
        type: choice
        options:
          - dev
          - test
          - staging
          - prod
      lifecycle:
        description: "Lifecycle (ephemeral or persistent)"
        required: true
        default: "persistent"
        type: choice
        options:
          - ephemeral
          - persistent
      build_id:
        description: "Build ID for ephemeral runs"
        required: false
        default: ""
      new_build:
        description: "Confirm a new ephemeral build (required when lifecycle=ephemeral)"
        required: true
        default: false
        type: boolean
      require_state:
        description: "Fail if remote state object is missing"
        required: true
        default: false
        type: boolean

jobs:
  terraform-fmt:
    name: Terraform fmt (check)
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform fmt
        run: terraform fmt -check -recursive

  terraform-validate:
    name: Terraform validate
    runs-on: ubuntu-latest
    permissions:
      contents: read
    strategy:
      matrix:
        dir:
          - .
          - envs/dev
          - envs/test
          - envs/staging
          - envs/prod
          - modules/aws_compute
          - modules/aws_eks
          - modules/aws_iam
          - modules/aws_nic
          - modules/aws_route_table
          - modules/aws_sg
          - modules/aws_subnet
          - modules/vpc
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform init (no backend)
        run: terraform -chdir=${{ matrix.dir }} init -backend=false

      - name: Enforce lockfile stability
        run: |
          LOCKFILE="${{ matrix.dir }}/.terraform.lock.hcl"
          if git ls-files --error-unmatch "${LOCKFILE}" >/dev/null 2>&1; then
            if ! git diff --exit-code -- "${LOCKFILE}"; then
              echo "Terraform lockfile drift detected in ${LOCKFILE}. Run init/upgrade locally and commit the lockfile."
              exit 1
            fi
          fi

      - name: Terraform validate
        run: terraform -chdir=${{ matrix.dir }} validate

  terraform-plan:
    name: Terraform plan
    runs-on: ubuntu-latest
    env:
      ENABLE_TF_K8S_RESOURCES: "false"
      CLUSTER_LIFECYCLE: ${{ inputs.lifecycle }}
      BUILD_ID: ${{ inputs.build_id }}
      NEW_BUILD: ${{ inputs.new_build }}
    permissions:
      contents: read
      id-token: write
    needs:
      - terraform-fmt
      - terraform-validate
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Resolve backend config
        id: backend
        run: |
          case "${{ inputs.env }}" in
            dev)
              echo "role=${{ secrets.TF_AWS_IAM_ROLE_DEV }}" >> "$GITHUB_OUTPUT"
              echo "bucket=goldenpath-idp-dev-bucket" >> "$GITHUB_OUTPUT"
              echo "table=goldenpath-idp-dev-db-key" >> "$GITHUB_OUTPUT"
              ;;
            test)
              echo "role=${{ secrets.TF_AWS_IAM_ROLE_TEST }}" >> "$GITHUB_OUTPUT"
              echo "bucket=goldenpath-test-staging-bucket" >> "$GITHUB_OUTPUT"
              echo "table=goldenpath-idp-test-db" >> "$GITHUB_OUTPUT"
              ;;
            staging)
              echo "role=${{ secrets.TF_AWS_IAM_ROLE_STAGING }}" >> "$GITHUB_OUTPUT"
              echo "bucket=goldenpath-idp-staging-bucket" >> "$GITHUB_OUTPUT"
              echo "table=goldenpath-idp-staging-db" >> "$GITHUB_OUTPUT"
              ;;
            prod)
              echo "role=${{ secrets.TF_AWS_IAM_ROLE_PROD }}" >> "$GITHUB_OUTPUT"
              echo "bucket=goldenpath-idp-prod-bucket" >> "$GITHUB_OUTPUT"
              echo "table=goldenpath-idp-prod-db" >> "$GITHUB_OUTPUT"
              ;;
            *)
              echo "Unsupported env: ${{ inputs.env }}" >&2
              exit 1
              ;;
          esac

      - name: Configure AWS credentials using OIDC
        uses: aws-actions/configure-aws-credentials@v4.1.0
        with:
          aws-region: eu-west-2
          role-to-assume: ${{ steps.backend.outputs.role }}

      - name: Resolve state key
        run: |
          if [[ "${CLUSTER_LIFECYCLE}" == "ephemeral" ]]; then
            if [[ "${NEW_BUILD}" != "true" ]]; then
              echo "new_build must be true when lifecycle=ephemeral" >&2
              exit 1
            fi
            if [[ -z "${BUILD_ID}" ]]; then
              echo "build_id is required when lifecycle=ephemeral" >&2
              exit 1
            fi
            if ! echo "${BUILD_ID}" | grep -Eq '^[0-9]{2}-[0-9]{2}-[0-9]{2}-[0-9]{2}$'; then
              echo "Invalid BUILD_ID: ${BUILD_ID} (expected dd-mm-yy-NN)" >&2
              exit 1
            fi
            STATE_KEY="envs/${{ inputs.env }}/builds/${BUILD_ID}/terraform.tfstate"
          else
            if [[ "${NEW_BUILD}" == "true" ]]; then
              echo "new_build is only valid for lifecycle=ephemeral" >&2
              exit 1
            fi
            if [[ -n "${BUILD_ID}" ]]; then
              echo "build_id is only valid for lifecycle=ephemeral" >&2
              exit 1
            fi
            STATE_KEY="envs/${{ inputs.env }}/terraform.tfstate"
          fi
          echo "STATE_KEY=${STATE_KEY}" >> "${GITHUB_ENV}"
          echo "Resolved STATE_KEY=${STATE_KEY}"

      - name: CI summary (state selection)
        run: |
          echo "Lifecycle=${CLUSTER_LIFECYCLE}"
          echo "BuildId=${BUILD_ID}"
          echo "NewBuild=${NEW_BUILD}"
          echo "StateKey=${STATE_KEY}"

      - name: Terraform init (backend)
        run: |
          terraform -chdir=envs/${{ inputs.env }} init -reconfigure \
            -backend-config="bucket=${{ steps.backend.outputs.bucket }}" \
            -backend-config="key=${STATE_KEY}" \
            -backend-config="region=eu-west-2" \
            -backend-config="dynamodb_table=${{ steps.backend.outputs.table }}" \
            -backend-config="encrypt=true"

      - name: Guard - backend state must exist
        if: ${{ inputs.require_state }}
        run: |
          echo "Checking state: s3://${{ steps.backend.outputs.bucket }}/${STATE_KEY}"
          if ! aws s3api head-object --bucket "${{ steps.backend.outputs.bucket }}" --key "${STATE_KEY}" >/dev/null 2>&1; then
            echo "Missing state file in backend. Run infra apply first or migrate local state." >&2
            exit 1
          fi

      - name: Terraform plan
        run: |
          var_args=(-var "cluster_lifecycle=${{ inputs.lifecycle }}")
          if [[ "${{ inputs.lifecycle }}" == "ephemeral" ]]; then
            var_args+=(-var "build_id=${{ inputs.build_id }}")
          fi
          terraform -chdir=envs/${{ inputs.env }} plan -input=false -no-color -out=plan.tfplan "${var_args[@]}"

      - name: Plan summary
        run: |
          terraform -chdir=envs/${{ inputs.env }} show -json plan.tfplan > plan.json
          python - <<'PY'
          import json
          with open("plan.json", "r", encoding="utf-8") as handle:
              data = json.load(handle)
          counts = {
              "create": 0,
              "update": 0,
              "delete": 0,
              "replace": 0,
              "read": 0,
              "no_op": 0,
          }
          for change in data.get("resource_changes", []):
              actions = change.get("change", {}).get("actions", [])
              if actions == ["no-op"]:
                  counts["no_op"] += 1
              elif "create" in actions and "delete" in actions:
                  counts["replace"] += 1
              else:
                  for action in actions:
                      if action in counts:
                          counts[action] += 1
          print("Plan summary:")
          for key in ("create", "update", "delete", "replace", "read", "no_op"):
              print(f"{key}: {counts[key]}")
          PY
      - name: Runbook link
        if: always()
        run: |
          echo "Runbook: docs/21_CI_ENVIRONMENT_CONTRACT.md" >> "${GITHUB_STEP_SUMMARY}"
