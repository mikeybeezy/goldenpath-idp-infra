# Owner: platform
# Description: Automatically applies Terraform changes and generates GitOps manifests when SecretRequest PRs are merged.
# Relates-To: 85-how-it-works/secrets-flow/SECRET_REQUEST_FLOW.md
name: Secret Requests (Apply)

on:
  pull_request:
    types: [closed]
    branches: ["main", "development"]
  push:
    branches: ["main", "development"]
    paths:
      - "docs/20-contracts/secret-requests/**"

permissions:
  contents: write

jobs:
  apply-and-sync:
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'push') ||
      (github.event_name == 'pull_request' && github.event.pull_request.merged == true && contains(github.event.pull_request.labels.*.name, 'secret-request'))
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Detect changed SecretRequest files
        id: changed
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            BASE="${{ github.event.pull_request.base.sha }}"
            HEAD="${{ github.event.pull_request.head.sha }}"
            CHANGED=$(git diff --name-only "$BASE" "$HEAD" | grep -E '^docs/20-contracts/secret-requests/.+\.ya?ml$' || true)
          else
            BEFORE="${{ github.event.before }}"
            AFTER="${{ github.sha }}"
            if [[ "$BEFORE" == "0000000000000000000000000000000000000000" ]]; then
               CHANGED=$(git show --name-only --pretty="" | grep -E '^docs/20-contracts/secret-requests/.+\.ya?ml$' || true)
            else
               CHANGED=$(git diff --name-only "$BEFORE" "$AFTER" | grep -E '^docs/20-contracts/secret-requests/.+\.ya?ml$' || true)
            fi
          fi
          echo "files<<EOF" >> "$GITHUB_OUTPUT"
          echo "$CHANGED" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Generate TF vars + ExternalSecrets
        if: steps.changed.outputs.files != ''
        env:
          CHANGED_FILES: ${{ steps.changed.outputs.files }}
        run: |
          set -euo pipefail
          # Convert newline-separated files to space-separated for argparse nargs='+'
          FILE_LIST=$(echo "$CHANGED_FILES" | tr '\n' ' ')

          python scripts/secret_request_parser.py \
            --mode generate \
            --input-files $FILE_LIST \
            --enums schemas/metadata/enums.yaml \
            --tfvars-out-root envs \
            --externalsecret-out-root gitops

      - name: Commit generated outputs
        if: steps.changed.outputs.files != ''
        run: |
          set -euo pipefail
          git config user.name "goldenpath-bot"
          git config user.email "goldenpath-bot@users.noreply.github.com"

          git add envs/**/secrets/generated/**.auto.tfvars.json || true
          git add gitops/kustomize/overlays/**/apps/**/externalsecrets/**.yaml || true

          if git diff --cached --quiet; then
            echo "No generated changes to commit."
            exit 0
          fi

          git commit -m "chore(secrets): generate tfvars + ExternalSecret manifests [skip ci]"
          git push

      - name: Setup Terraform
        if: steps.changed.outputs.files != ''
        uses: hashicorp/setup-terraform@v3

      - name: Configure AWS credentials (Apply Role)
        if: steps.changed.outputs.files != ''
        uses: aws-actions/configure-aws-credentials@v4.1.0
        with:
          aws-region: eu-west-2
          role-to-assume: ${{ secrets.TF_AWS_IAM_ROLE_DEV_APPLY }}

      - name: Resolve Context & Terraform Init
        if: steps.changed.outputs.files != ''
        id: context
        run: |
          # Read context from dev environment (hardcoded to dev for this workflow)
          LIFECYCLE=$(grep "cluster_lifecycle" envs/dev/terraform.tfvars | cut -d'"' -f2)
          BUILD_ID=$(grep "build_id" envs/dev/terraform.tfvars | cut -d'"' -f2)

          if [[ "$LIFECYCLE" == "ephemeral" ]]; then
            STATE_KEY="envs/dev/builds/${BUILD_ID}/terraform.tfstate"
          else
            STATE_KEY="envs/dev/terraform.tfstate"
          fi

          echo "lifecycle=$LIFECYCLE" >> $GITHUB_OUTPUT
          echo "build_id=$BUILD_ID" >> $GITHUB_OUTPUT

          terraform -chdir=envs/dev init \
            -backend-config="bucket=goldenpath-idp-dev-bucket" \
            -backend-config="key=$STATE_KEY" \
            -backend-config="region=eu-west-2" \
            -backend-config="dynamodb_table=goldenpath-idp-dev-db-key" \
            -backend-config="encrypt=true"

      - name: Terraform Apply (Surgical)
        if: steps.changed.outputs.files != ''
        env:
          CHANGED_FILES: ${{ steps.changed.outputs.files }}
        run: |
          set -euo pipefail

          # We need to construct -target and -var-file for each changed secret
          TARGETS=""
          VAR_FILES=""
          for FILE in $CHANGED_FILES; do
              echo "ðŸ”¬ Extracting metadata from $FILE..."
              # Robust metadata extraction supporting both top-level and nested metadata block
              eval $(python3 -c "import yaml; d = yaml.safe_load(open('$FILE')) or {}; m = d.get('metadata', {}); print(f\"SERVICE={m.get('service', d.get('service', 'unknown'))}\"); print(f\"NAME={m.get('name', d.get('name', 'unknown'))}\");")

              ID=$(basename "$FILE" .yaml)
              echo "ðŸš€ Targeting $ID (Service: $SERVICE, Name: $NAME)"
              TARGETS="$TARGETS -target=\"module.app_secrets[\\\"$SERVICE-$NAME\\\"]\""
              VAR_FILES="$VAR_FILES -var-file=\"secrets/generated/$SERVICE/$ID.auto.tfvars.json\""
          done

          echo "ðŸš€ Provisioning targeted secrets: $TARGETS"
          echo "ðŸ“˜ Using var-files: $VAR_FILES"

          var_args=(-var "cluster_lifecycle=${{ steps.context.outputs.lifecycle }}")
          if [[ "${{ steps.context.outputs.lifecycle }}" == "ephemeral" ]]; then
            var_args+=(-var "build_id=${{ steps.context.outputs.build_id }}")
          fi

          terraform -chdir=envs/dev apply -auto-approve -input=false -no-color \
            $VAR_FILES $TARGETS "${var_args[@]}"
