# Owner: platform
# Relates-To: how-it-works/SECRET_REQUEST_FLOW.md
name: Secret Requests (Apply)

on:
  push:
    branches: ["main", "development"]
    paths:
      - "docs/catalogs/secrets/**"
      - "schemas/metadata/**"
      - "scripts/secret_request_parser.py"

permissions:
  contents: write

jobs:
  apply-and-sync:
    runs-on: ubuntu-latest
    if: github.actor != 'goldenpath-bot'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Detect changed SecretRequest files
        id: changed
        shell: bash
        run: |
          set -euo pipefail
          BEFORE="${{ github.event.before }}"
          AFTER="${{ github.sha }}"
          CHANGED=$(git diff --name-only "$BEFORE" "$AFTER" | grep -E '^docs/catalogs/secrets/.+\.ya?ml$' || true)
          echo "files<<EOF" >> "$GITHUB_OUTPUT"
          echo "$CHANGED" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Generate TF vars + ExternalSecrets
        if: steps.changed.outputs.files != ''
        run: |
          set -euo pipefail
          python scripts/secret_request_parser.py \
            --mode generate \
            --input-files ${{ steps.changed.outputs.files }} \
            --enums schemas/metadata/enums.yaml \
            --tfvars-out-root envs \
            --externalsecret-out-root gitops

      - name: Commit generated outputs
        if: steps.changed.outputs.files != ''
        run: |
          set -euo pipefail
          git config user.name "goldenpath-bot"
          git config user.email "goldenpath-bot@users.noreply.github.com"

          git add envs/**/secrets/generated/**.auto.tfvars.json || true
          git add gitops/kustomize/overlays/**/apps/**/externalsecrets/**.yaml || true

          if git diff --cached --quiet; then
            echo "No generated changes to commit."
            exit 0
          fi

          git commit -m "chore(secrets): generate tfvars + ExternalSecret manifests [skip ci]"
          git push

      - name: Terraform apply simulation
        if: steps.changed.outputs.files != ''
        run: |
          echo "ðŸš€ Provisioning secrets in AWS..."
          echo "âœ… Secrets provisioned."
