# Owner: platform
name: Policy - PR Guardrails

on:
  pull_request:
    branches:
      - main
      - development
    types: [opened, edited, synchronize, reopened, ready_for_review]

permissions:
  contents: read
  pull-requests: read

jobs:
  pr-guardrails:
    runs-on: ubuntu-latest
    steps:
      - name: Enforce PR checklist selections
        uses: actions/github-script@v7
        with:
          script: |
            // Check for exempt labels first (ADR-0101)
            const exemptLabels = [
              'governance-exempt',
              'buildid',
              'docs-only',
              'typo-fix',
              'hotfix'
            ];
            const prLabels = context.payload.pull_request.labels.map(l => l.name);
            const isExempt = prLabels.some(l => exemptLabels.includes(l));
            if (isExempt) {
              core.info(`âœ… Guardrails skipped (exempt label: ${prLabels.filter(l => exemptLabels.includes(l)).join(', ')})`);
              return;
            }

            const body = context.payload.pull_request.body || "";
            const escapeRegex = (text) => text.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
            const templateHeader =
              "Select at least one checkbox per section by changing `[ ]` to `[x]`.";
            const errors = [];

            if (!body.includes(templateHeader)) {
              errors.push(
                "PR body must be based on `.github/pull_request_template.md` (missing template header)."
              );
            }

            if (body.includes("\\n")) {
              errors.push(
                "PR body contains escaped newlines (\\\\n). Replace them with real line breaks or use `gh pr create -F .github/pull_request_template.md`."
              );
            }
            const isChecked = (label) => {
              const pattern = new RegExp(`- \\[[xX]\\] ${escapeRegex(label)}`);
              return pattern.test(body);
            };

            const sections = [
              {
                name: "Change Type",
                labels: ["Feature", "Bug fix", "Infra change", "Governance / Policy"],
              },
              {
                name: "Decision Impact",
                labels: ["Requires ADR", "Updates existing ADR", "No architectural impact"],
              },
              {
                name: "Production Readiness",
                labels: ["Readiness checklist completed", "No production impact"],
              },
              {
                name: "Testing / Validation",
                labels: [
                  "Plan/apply link provided (paste below)",
                  "Test command or run ID provided (paste below)",
                  "Not applicable",
                ],
              },
              {
                name: "Risk & Rollback",
                labels: [
                  "Rollback plan documented (link or notes below)",
                  "Data migration required",
                  "No data migration",
                  "Not applicable",
                ],
              },
            ];

            const missing = sections.filter(section =>
              !section.labels.some(label => isChecked(label))
            );

            if (missing.length) {
              errors.push(
                `Missing required PR checklist selections: ${missing.map(s => s.name).join(", ")}.`
              );
            }

            if (errors.length) {
              core.setFailed(errors.join(" "));
            }
