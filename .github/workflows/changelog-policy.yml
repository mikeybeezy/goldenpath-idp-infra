# Owner: platform
name: Policy - Changelog Policy

on:
  pull_request:
    branches:
      - main
    types:
      - opened
      - reopened
      - synchronize
      - labeled
      - unlabeled
      - edited
      - ready_for_review

permissions:
  contents: read
  pull-requests: read

jobs:
  changelog-policy:
    runs-on: ubuntu-latest
    steps:
      - name: Enforce label-gated changelog entry
        uses: actions/github-script@v7
        with:
          script: |
            const requiredLabel = "changelog-required";
            const exemptLabel = "changelog-exempt";
            const entryRegex = /^docs\/changelog\/entries\/CL-\d{4}-.*\.md$/;
            const { owner, repo } = context.repo;
            const issue_number = context.issue.number;

            const { data: labels } = await github.rest.issues.listLabelsOnIssue({
              owner,
              repo,
              issue_number,
            });

            const hasRequired = labels.some((label) => label.name === requiredLabel);
            const hasExempt = labels.some((label) => label.name === exemptLabel);
            if (!hasRequired) {
              core.info("Changelog label not set; skipping.");
              return;
            }
            if (hasExempt) {
              core.info("Changelog exempt label set; skipping.");
              return;
            }

            const files = await github.paginate(github.rest.pulls.listFiles, {
              owner,
              repo,
              pull_number: issue_number,
              per_page: 100,
            });

            const hasEntry = files.some((file) => entryRegex.test(file.filename));
            if (!hasEntry) {
              core.setFailed(
                "Missing changelog entry. Add docs/changelog/entries/CL-####-short-title.md.",
              );
              return;
            }

            core.info("Changelog entry detected.");
      - name: Runbook link
        if: always()
        run: |
          echo "Runbook: docs/changelog/README.md" >> "${GITHUB_STEP_SUMMARY}"
