name: Infra Terraform Pipeline
run-name: "infra-pipeline (env=${{ inputs.env }}, lifecycle=${{ inputs.lifecycle }}, build_id=${{ inputs.build_id }})"

on:
  workflow_dispatch:
    inputs:
      env:
        description: "Environment to target (dev/test/staging/prod)"
        required: true
        default: "dev"
        type: choice
        options:
          - dev
          - test
          - staging
          - prod
      confirm_apply:
        description: "Type 'apply' to confirm apply"
        required: true
        default: "cancel"
        type: choice
        options:
          - cancel
          - apply
      lifecycle:
        description: "Lifecycle (ephemeral or persistent)"
        required: true
        default: "ephemeral"
        type: choice
        options:
          - ephemeral
          - persistent
      build_id:
        description: "Build ID for ephemeral runs (dd-mm-yy-NN)"
        required: false
        default: ""
        type: string
      require_state:
        description: "Fail if persistent state object is missing"
        required: true
        default: false
        type: boolean
      region:
        description: "AWS region"
        required: true
        default: "eu-west-2"

jobs:
  plan:
    name: Terraform plan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    env:
      ENV: ${{ inputs.env }}
      AWS_REGION: ${{ inputs.region }}
      CLUSTER_LIFECYCLE: ${{ inputs.lifecycle }}
      BUILD_ID: ${{ inputs.build_id }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Note apply role expectation
        run: |
          echo "Apply role secrets must exist for the selected environment."
          echo "Expected secrets: TF_AWS_IAM_ROLE_DEV_APPLY, TF_AWS_IAM_ROLE_TEST_APPLY, TF_AWS_IAM_ROLE_STAGING_APPLY, TF_AWS_IAM_ROLE_PROD_APPLY"

      - name: Validate lifecycle and build ID
        shell: bash
        run: |
          if [[ "${CLUSTER_LIFECYCLE}" == "ephemeral" ]]; then
            if [[ -z "${BUILD_ID}" ]]; then
              echo "build_id is required when lifecycle=ephemeral" >&2
              exit 1
            fi
          fi
          if [[ -n "${BUILD_ID}" ]] && ! [[ "${BUILD_ID}" =~ ^[0-9]{2}-[0-9]{2}-[0-9]{2}-[0-9]{2}$ ]]; then
            echo "Invalid build_id: '${BUILD_ID}' (expected dd-mm-yy-NN)" >&2
            exit 1
          fi

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Resolve backend config
        id: backend
        run: |
          case "${ENV}" in
            dev)
              echo "role=${{ secrets.TF_AWS_IAM_ROLE_DEV }}" >> "$GITHUB_OUTPUT"
              echo "bucket=goldenpath-idp-dev-bucket" >> "$GITHUB_OUTPUT"
              echo "table=goldenpath-idp-dev-db-key" >> "$GITHUB_OUTPUT"
              ;;
            test)
              echo "role=${{ secrets.TF_AWS_IAM_ROLE_TEST }}" >> "$GITHUB_OUTPUT"
              echo "bucket=goldenpath-test-staging-bucket" >> "$GITHUB_OUTPUT"
              echo "table=goldenpath-idp-test-db" >> "$GITHUB_OUTPUT"
              ;;
            staging)
              echo "role=${{ secrets.TF_AWS_IAM_ROLE_STAGING }}" >> "$GITHUB_OUTPUT"
              echo "bucket=goldenpath-idp-staging-bucket" >> "$GITHUB_OUTPUT"
              echo "table=goldenpath-idp-staging-db" >> "$GITHUB_OUTPUT"
              ;;
            prod)
              echo "role=${{ secrets.TF_AWS_IAM_ROLE_PROD }}" >> "$GITHUB_OUTPUT"
              echo "bucket=goldenpath-idp-prod-bucket" >> "$GITHUB_OUTPUT"
              echo "table=goldenpath-idp-prod-db" >> "$GITHUB_OUTPUT"
              ;;
            *)
              echo "Unsupported env: ${ENV}" >&2
              exit 1
              ;;
          esac

      - name: Configure AWS credentials using OIDC (plan role)
        uses: aws-actions/configure-aws-credentials@v4.1.0
        with:
          aws-region: ${{ inputs.region }}
          role-to-assume: ${{ steps.backend.outputs.role }}

      - name: Resolve state key
        run: |
          if [[ "${CLUSTER_LIFECYCLE}" == "ephemeral" ]]; then
            STATE_KEY="envs/${ENV}/builds/${BUILD_ID}/terraform.tfstate"
          else
            STATE_KEY="envs/${ENV}/terraform.tfstate"
          fi
          echo "STATE_KEY=${STATE_KEY}" >> "${GITHUB_ENV}"
          echo "Resolved STATE_KEY=${STATE_KEY}"

      - name: Guard - backend state must exist (persistent only)
        if: ${{ inputs.require_state }}
        run: |
          if [[ "${CLUSTER_LIFECYCLE}" == "persistent" ]]; then
            echo "Checking state: s3://${{ steps.backend.outputs.bucket }}/${STATE_KEY}"
            if ! aws s3api head-object --bucket "${{ steps.backend.outputs.bucket }}" --key "${STATE_KEY}" >/dev/null 2>&1; then
              echo "Missing state file in backend. Run infra apply first or migrate local state." >&2
              exit 1
            fi
          else
            echo "Skipping state existence check for ephemeral lifecycle."
          fi

      - name: CI summary (state selection)
        run: |
          echo "Lifecycle=${CLUSTER_LIFECYCLE}"
          echo "BuildId=${BUILD_ID}"
          echo "StateKey=${STATE_KEY}"

      - name: Terraform init (backend)
        run: |
          terraform -chdir=envs/${ENV} init -reconfigure \
            -backend-config="bucket=${{ steps.backend.outputs.bucket }}" \
            -backend-config="key=${STATE_KEY}" \
            -backend-config="region=${AWS_REGION}" \
            -backend-config="dynamodb_table=${{ steps.backend.outputs.table }}" \
            -backend-config="encrypt=true"

      - name: Terraform plan
        env:
          TF_VAR_cluster_lifecycle: ${{ inputs.lifecycle }}
          TF_VAR_build_id: ${{ inputs.build_id }}
        run: terraform -chdir=envs/${ENV} plan -input=false -no-color

  apply:
    name: Terraform apply
    runs-on: ubuntu-latest
    needs: plan
    if: ${{ inputs.confirm_apply == 'apply' }}
    permissions:
      contents: read
      id-token: write
    env:
      ENV: ${{ inputs.env }}
      AWS_REGION: ${{ inputs.region }}
      CLUSTER_LIFECYCLE: ${{ inputs.lifecycle }}
      BUILD_ID: ${{ inputs.build_id }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Validate lifecycle and build ID
        shell: bash
        run: |
          if [[ "${CLUSTER_LIFECYCLE}" == "ephemeral" ]]; then
            if [[ -z "${BUILD_ID}" ]]; then
              echo "build_id is required when lifecycle=ephemeral" >&2
              exit 1
            fi
          fi
          if [[ -n "${BUILD_ID}" ]] && ! [[ "${BUILD_ID}" =~ ^[0-9]{2}-[0-9]{2}-[0-9]{2}-[0-9]{2}$ ]]; then
            echo "Invalid build_id: '${BUILD_ID}' (expected dd-mm-yy-NN)" >&2
            exit 1
          fi

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Resolve backend config
        id: backend
        run: |
          case "${ENV}" in
            dev)
              echo "role=${{ secrets.TF_AWS_IAM_ROLE_DEV_APPLY }}" >> "$GITHUB_OUTPUT"
              echo "bucket=goldenpath-idp-dev-bucket" >> "$GITHUB_OUTPUT"
              echo "table=goldenpath-idp-dev-db-key" >> "$GITHUB_OUTPUT"
              ;;
            test)
              echo "role=${{ secrets.TF_AWS_IAM_ROLE_TEST_APPLY }}" >> "$GITHUB_OUTPUT"
              echo "bucket=goldenpath-test-staging-bucket" >> "$GITHUB_OUTPUT"
              echo "table=goldenpath-idp-test-db" >> "$GITHUB_OUTPUT"
              ;;
            staging)
              echo "role=${{ secrets.TF_AWS_IAM_ROLE_STAGING_APPLY }}" >> "$GITHUB_OUTPUT"
              echo "bucket=goldenpath-idp-staging-bucket" >> "$GITHUB_OUTPUT"
              echo "table=goldenpath-idp-staging-db" >> "$GITHUB_OUTPUT"
              ;;
            prod)
              echo "role=${{ secrets.TF_AWS_IAM_ROLE_PROD_APPLY }}" >> "$GITHUB_OUTPUT"
              echo "bucket=goldenpath-idp-prod-bucket" >> "$GITHUB_OUTPUT"
              echo "table=goldenpath-idp-prod-db" >> "$GITHUB_OUTPUT"
              ;;
            *)
              echo "Unsupported env: ${ENV}" >&2
              exit 1
              ;;
          esac

      - name: Configure AWS credentials using OIDC (apply role)
        uses: aws-actions/configure-aws-credentials@v4.1.0
        with:
          aws-region: ${{ inputs.region }}
          role-to-assume: ${{ steps.backend.outputs.role }}

      - name: Resolve state key
        run: |
          if [[ "${CLUSTER_LIFECYCLE}" == "ephemeral" ]]; then
            STATE_KEY="envs/${ENV}/builds/${BUILD_ID}/terraform.tfstate"
          else
            STATE_KEY="envs/${ENV}/terraform.tfstate"
          fi
          echo "STATE_KEY=${STATE_KEY}" >> "${GITHUB_ENV}"
          echo "Resolved STATE_KEY=${STATE_KEY}"

      - name: Guard - backend state must exist (persistent only)
        if: ${{ inputs.require_state }}
        run: |
          if [[ "${CLUSTER_LIFECYCLE}" == "persistent" ]]; then
            echo "Checking state: s3://${{ steps.backend.outputs.bucket }}/${STATE_KEY}"
            if ! aws s3api head-object --bucket "${{ steps.backend.outputs.bucket }}" --key "${STATE_KEY}" >/dev/null 2>&1; then
              echo "Missing state file in backend. Run infra apply first or migrate local state." >&2
              exit 1
            fi
          else
            echo "Skipping state existence check for ephemeral lifecycle."
          fi

      - name: CI summary (state selection)
        run: |
          echo "Lifecycle=${CLUSTER_LIFECYCLE}"
          echo "BuildId=${BUILD_ID}"
          echo "StateKey=${STATE_KEY}"

      - name: Terraform init (backend)
        run: |
          terraform -chdir=envs/${ENV} init \
            -backend-config="bucket=${{ steps.backend.outputs.bucket }}" \
            -backend-config="key=${STATE_KEY}" \
            -backend-config="region=${AWS_REGION}" \
            -backend-config="dynamodb_table=${{ steps.backend.outputs.table }}" \
            -backend-config="encrypt=true"

      - name: Terraform apply
        env:
          TF_VAR_cluster_lifecycle: ${{ inputs.lifecycle }}
          TF_VAR_build_id: ${{ inputs.build_id }}
        run: terraform -chdir=envs/${ENV} apply -auto-approve -input=false -no-color
