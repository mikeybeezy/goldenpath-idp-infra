# Canonical Build and Release Workflow
# GOV-0012: All app repos MUST use this reusable workflow
# GOV-0013: DevSecOps security gates enforced per environment
# GOV-0014: Implementation matrix reference
#
# Usage in app repo (.github/workflows/delivery.yml):
#   jobs:
#     build:
#       uses: mikeybeezy/goldenpath-idp-infra/.github/workflows/_build-and-release.yml@main
#       with:
#         ecr_repository: my-app-name
#       secrets:
#         AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

name: _build-and-release

on:
  workflow_call:
    inputs:
      ecr_repository:
        description: 'ECR repository name'
        required: true
        type: string
      dockerfile_path:
        description: 'Path to Dockerfile'
        required: false
        default: './Dockerfile'
        type: string
      build_context:
        description: 'Docker build context'
        required: false
        default: '.'
        type: string
      environment:
        description: 'Target environment (local, dev, test, staging, prod)'
        required: false
        default: 'dev'
        type: string
      image_tag:
        description: 'Image tag override (defaults to git SHA)'
        required: false
        default: ''
        type: string
      push_latest:
        description: 'Push :latest tag (only for local/dev)'
        required: false
        default: true
        type: boolean
      trivy_exit_code:
        description: 'Trivy exit code override (0=advisory, 1=blocking; leave blank for env default)'
        required: false
        default: ''
        type: string
      skip_push:
        description: 'Skip push to ECR (for PR builds)'
        required: false
        default: false
        type: boolean
      # Test configuration
      test_enabled:
        description: 'Enable test execution'
        required: false
        default: true
        type: boolean
      test_command:
        description: 'Test command to run (e.g., pytest, npm test, go test)'
        required: false
        default: ''
        type: string
      test_working_directory:
        description: 'Working directory for tests'
        required: false
        default: '.'
        type: string
      python_version:
        description: 'Python version (if using Python)'
        required: false
        default: ''
        type: string
      node_version:
        description: 'Node.js version (if using Node)'
        required: false
        default: ''
        type: string
      go_version:
        description: 'Go version (if using Go)'
        required: false
        default: ''
        type: string
    secrets:
      AWS_ROLE_ARN:
        description: 'AWS IAM role ARN for OIDC authentication'
        required: false
      AWS_ACCESS_KEY_ID:
        description: 'AWS access key (fallback for non-OIDC)'
        required: false
      AWS_SECRET_ACCESS_KEY:
        description: 'AWS secret key (fallback for non-OIDC)'
        required: false
    outputs:
      image:
        description: 'Full image URI with tag'
        value: ${{ jobs.build.outputs.image }}
      image_digest:
        description: 'Image digest (sha256)'
        value: ${{ jobs.build.outputs.digest }}
      sbom_artifact:
        description: 'SBOM artifact name'
        value: ${{ jobs.build.outputs.sbom_artifact }}

env:
  AWS_REGION: eu-west-2

jobs:
  # ============================================================================
  # Security Scan: Gitleaks (Secrets Detection)
  # GOV-0013: Blocking for test/staging/prod, Advisory for local/dev
  # ============================================================================
  gitleaks:
    name: Gitleaks Secret Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      result: ${{ steps.gitleaks.outcome }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine gating mode
        id: gate-mode
        run: |
          ENV="${{ inputs.environment }}"
          if [[ "$ENV" == "local" || "$ENV" == "dev" ]]; then
            echo "blocking=false" >> "$GITHUB_OUTPUT"
            echo "Gitleaks mode: ADVISORY (local/dev)"
          else
            echo "blocking=true" >> "$GITHUB_OUTPUT"
            echo "Gitleaks mode: BLOCKING (test/staging/prod)"
          fi

      - name: Run Gitleaks
        id: gitleaks
        uses: gitleaks/gitleaks-action@v2
        continue-on-error: ${{ steps.gate-mode.outputs.blocking == 'false' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Gitleaks Advisory Warning
        if: steps.gitleaks.outcome == 'failure' && steps.gate-mode.outputs.blocking == 'false'
        run: |
          echo "::warning::Gitleaks detected potential secrets but is in ADVISORY mode for ${{ inputs.environment }}"
          echo "::warning::This would be BLOCKING in test/staging/prod environments"

  # ============================================================================
  # Test: Unit and Integration Tests
  # Runs before build to fail fast on test failures
  # ============================================================================
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: [gitleaks]
    if: inputs.test_enabled == true && inputs.test_command != ''
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Python setup (if version specified)
      - name: Set up Python
        if: inputs.python_version != ''
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}

      - name: Install Python dependencies
        if: inputs.python_version != ''
        working-directory: ${{ inputs.test_working_directory }}
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi
          if [ -f pyproject.toml ]; then pip install -e ".[dev]" 2>/dev/null || pip install -e .; fi

      # Node.js setup (if version specified)
      - name: Set up Node.js
        if: inputs.node_version != ''
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node_version }}
          cache: 'npm'
          cache-dependency-path: '${{ inputs.test_working_directory }}/package-lock.json'

      - name: Install Node.js dependencies
        if: inputs.node_version != ''
        working-directory: ${{ inputs.test_working_directory }}
        run: npm ci

      # Go setup (if version specified)
      - name: Set up Go
        if: inputs.go_version != ''
        uses: actions/setup-go@v5
        with:
          go-version: ${{ inputs.go_version }}

      # Run tests
      - name: Run tests
        working-directory: ${{ inputs.test_working_directory }}
        run: |
          echo "Running: ${{ inputs.test_command }}"
          ${{ inputs.test_command }}

      - name: Test Summary
        if: always()
        run: |
          echo "### Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Command** | \`${{ inputs.test_command }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Working Directory** | \`${{ inputs.test_working_directory }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Status** | ${{ job.status }} |" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Build, Scan, Push
  # ============================================================================
  build:
    name: Build and Push
    runs-on: ubuntu-latest
    needs: [gitleaks, test]
    if: always() && needs.gitleaks.result == 'success' && (needs.test.result == 'success' || needs.test.result == 'skipped')
    permissions:
      id-token: write
      contents: read
      security-events: write  # Required for SARIF upload

    outputs:
      image: ${{ steps.build-image.outputs.image }}
      digest: ${{ steps.push.outputs.digest }}
      sbom_artifact: sbom-${{ inputs.ecr_repository }}-${{ github.run_id }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ----------------------------------------------------------------------
      # Determine environment-specific settings
      # ----------------------------------------------------------------------
      - name: Set environment config
        id: env-config
        run: |
          ENV="${{ inputs.environment }}"

          # Trivy exit code: 0=advisory (local/dev), 1=blocking (test+)
          if [[ "$ENV" == "local" || "$ENV" == "dev" ]]; then
            echo "trivy_exit_code=0" >> $GITHUB_OUTPUT
            echo "sarif_upload=false" >> $GITHUB_OUTPUT
            echo "sbom_required=false" >> $GITHUB_OUTPUT
            echo "allow_latest=true" >> $GITHUB_OUTPUT
          else
            echo "trivy_exit_code=1" >> $GITHUB_OUTPUT
            echo "sarif_upload=true" >> $GITHUB_OUTPUT
            echo "sbom_required=true" >> $GITHUB_OUTPUT
            echo "allow_latest=false" >> $GITHUB_OUTPUT
          fi

          # Only override when explicitly provided; keep env-based default otherwise.
          if [[ -n "${{ inputs.trivy_exit_code }}" ]]; then
            echo "trivy_exit_code=${{ inputs.trivy_exit_code }}" >> $GITHUB_OUTPUT
          fi

      # ----------------------------------------------------------------------
      # AWS Authentication
      # ----------------------------------------------------------------------
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # ----------------------------------------------------------------------
      # Build Image
      # ----------------------------------------------------------------------
      - name: Set image tag
        id: set-tag
        run: |
          if [[ -n "${{ inputs.image_tag }}" ]]; then
            TAG="${{ inputs.image_tag }}"
          else
            TAG="${{ github.sha }}"
          fi

          # For non-dev environments, prefix with environment
          ENV="${{ inputs.environment }}"
          if [[ "$ENV" != "local" && "$ENV" != "dev" ]]; then
            TAG="${ENV}-${TAG:0:7}"
          fi

          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Build image
        id: build-image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ${{ inputs.ecr_repository }}
          IMAGE_TAG: ${{ steps.set-tag.outputs.tag }}
        run: |
          IMAGE="$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"

          docker build \
            -f ${{ inputs.dockerfile_path }} \
            -t "$IMAGE" \
            ${{ inputs.build_context }}

          # Tag latest if allowed
          if [[ "${{ steps.env-config.outputs.allow_latest }}" == "true" && "${{ inputs.push_latest }}" == "true" ]]; then
            docker tag "$IMAGE" "$ECR_REGISTRY/$ECR_REPOSITORY:latest"
          fi

          echo "image=$IMAGE" >> $GITHUB_OUTPUT
          echo "registry=$ECR_REGISTRY" >> $GITHUB_OUTPUT
          echo "repository=$ECR_REPOSITORY" >> $GITHUB_OUTPUT
          echo "tag=$IMAGE_TAG" >> $GITHUB_OUTPUT

      # ----------------------------------------------------------------------
      # Security Scan: Trivy (Image Vulnerabilities)
      # GOV-0013: Blocking for test/staging/prod (HIGH, CRITICAL)
      # ----------------------------------------------------------------------
      - name: Scan image with Trivy
        uses: aquasecurity/trivy-action@0.28.0  # Pinned version per GOV-0012 (no @master/@latest)
        with:
          image-ref: ${{ steps.build-image.outputs.image }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          exit-code: ${{ steps.env-config.outputs.trivy_exit_code }}
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'HIGH,CRITICAL'

      - name: Upload Trivy scan results to GitHub Security tab
        if: steps.env-config.outputs.sarif_upload == 'true' && always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'
          category: 'trivy-${{ inputs.ecr_repository }}'

      # ----------------------------------------------------------------------
      # SBOM Generation: Syft
      # GOV-0013: Required for test/staging/prod
      # ----------------------------------------------------------------------
      - name: Generate SBOM with Syft
        uses: anchore/sbom-action@v0
        with:
          image: ${{ steps.build-image.outputs.image }}
          format: spdx-json
          output-file: sbom.spdx.json
          artifact-name: sbom-${{ inputs.ecr_repository }}-${{ github.run_id }}

      - name: Upload SBOM as artifact
        uses: actions/upload-artifact@v4
        with:
          name: sbom-${{ inputs.ecr_repository }}-${{ github.run_id }}
          path: sbom.spdx.json
          retention-days: 90

      # ----------------------------------------------------------------------
      # Push to ECR
      # ----------------------------------------------------------------------
      - name: Push to ECR
        id: push
        if: inputs.skip_push == false
        env:
          ECR_REGISTRY: ${{ steps.build-image.outputs.registry }}
          ECR_REPOSITORY: ${{ steps.build-image.outputs.repository }}
          IMAGE_TAG: ${{ steps.build-image.outputs.tag }}
        run: |
          docker push "$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"

          # Capture digest
          DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' "$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" 2>/dev/null | cut -d'@' -f2 || echo "")
          echo "digest=$DIGEST" >> $GITHUB_OUTPUT

          # Push latest if allowed
          if [[ "${{ steps.env-config.outputs.allow_latest }}" == "true" && "${{ inputs.push_latest }}" == "true" ]]; then
            docker push "$ECR_REGISTRY/$ECR_REPOSITORY:latest"
            echo "Pushed :latest tag"
          fi

      # ----------------------------------------------------------------------
      # Build Summary
      # ----------------------------------------------------------------------
      - name: Build Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ### Build Summary

          | Item | Value |
          |------|-------|
          | **Image** | `${{ steps.build-image.outputs.image }}` |
          | **Digest** | `${{ steps.push.outputs.digest || 'N/A (not pushed)' }}` |
          | **Environment** | `${{ inputs.environment }}` |
          | **Trivy Gate** | `${{ steps.env-config.outputs.trivy_exit_code == '1' && 'Blocking' || 'Advisory' }}` |
          | **SBOM** | `sbom-${{ inputs.ecr_repository }}-${{ github.run_id }}` |
          | **Pushed** | `${{ inputs.skip_push == false }}` |

          #### Pipeline Stages

          | Stage | Status |
          |-------|--------|
          | Gitleaks (Secrets) | Passed |
          | Tests | ${{ needs.test.result == 'skipped' && 'Skipped (no test_command)' || 'Passed' }} |
          | Build | Passed |
          | Trivy Scan | ${{ steps.env-config.outputs.trivy_exit_code == '1' && 'Blocking (HIGH/CRITICAL)' || 'Advisory' }} |
          | SBOM | Generated |
          | SARIF Upload | ${{ steps.env-config.outputs.sarif_upload == 'true' && 'Uploaded' || 'Skipped (dev)' }} |

          EOF
