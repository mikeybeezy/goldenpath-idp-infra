# Owner: platform-team
# Relates-To: SECRET_REQUEST_FLOW, ADR-0135, PR_GUARDRAILS_INDEX
name: Secret Approval Guard

on:
  pull_request:
    paths:
      - "docs/20-contracts/secret-requests/**/*.yaml"
      - "docs/20-contracts/secret-requests/**/*.yml"
  workflow_dispatch:

jobs:
  check-approval:
    runs-on: ubuntu-latest
    env:
      WARN_ONLY: "false"
    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate secret requests and check approvals
        shell: bash
        run: |
          set -euo pipefail
          python3 - <<'PY'
          import json
          import os
          import re
          import subprocess
          import sys

          import yaml

          event_path = os.environ.get("GITHUB_EVENT_PATH")
          warn_only = os.environ.get("WARN_ONLY", "false").lower() == "true"

          if not event_path:
              print("ERROR: GITHUB_EVENT_PATH is not set.")
              sys.exit(1)

          with open(event_path, "r", encoding="utf-8") as handle:
              event = json.load(handle)

          # Get changed files
          base = event.get("pull_request", {}).get("base", {}).get("sha", "HEAD~1")
          head = event.get("pull_request", {}).get("head", {}).get("sha", "HEAD")

          try:
              files = subprocess.check_output(
                  ["git", "diff", "--name-only", base, head],
                  text=True,
              ).splitlines()
          except subprocess.CalledProcessError:
              files = []

          # Filter to secret request files
          secret_requests = [
              f for f in files
              if f.startswith("docs/20-contracts/secret-requests/")
              and (f.endswith(".yaml") or f.endswith(".yml"))
          ]

          if not secret_requests:
              print("No secret request files changed.")
              sys.exit(0)

          # High-risk pattern
          high_risk_pattern = re.compile(r"tier:\s*high", re.IGNORECASE)

          flagged = []
          for path in secret_requests:
              try:
                  with open(path, "r", encoding="utf-8") as f:
                      content = f.read()
                  if high_risk_pattern.search(content):
                      flagged.append(path)
              except FileNotFoundError:
                  # File was deleted, skip
                  continue

          if not flagged:
              print("âœ… No high-risk secrets detected. Auto-approval allowed.")
              sys.exit(0)

          # Check for approval label
          labels = [l.get("name", "") for l in event.get("pull_request", {}).get("labels", [])]
          has_approval = "platform-approved" in labels or "high-risk-approved" in labels

          if has_approval:
              print(f"âœ… High-risk secrets detected but approval label found.")
              for f in flagged:
                  print(f"   - {f}")
              sys.exit(0)

          # High-risk without approval
          print("ðŸš« HIGH-RISK SECRETS REQUIRE APPROVAL")
          print("")
          print("The following secret requests are marked as high-risk:")
          for f in flagged:
              print(f"   - {f}")
          print("")
          print("To proceed, a platform-team member must:")
          print("  1. Review the PR")
          print("  2. Add the 'platform-approved' or 'high-risk-approved' label")
          print("")

          if warn_only:
              print("âš ï¸ WARN_ONLY mode: Allowing PR to proceed with warning.")
              sys.exit(0)
          else:
              print("ðŸš« Blocking PR until approval label is added.")
              sys.exit(1)
          PY

      - name: Summary
        if: always()
        run: |
          echo "## Secret Approval Guard" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Risk Level | Approval Required |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|-------------------|" >> $GITHUB_STEP_SUMMARY
          echo "| low | No |" >> $GITHUB_STEP_SUMMARY
          echo "| medium | No |" >> $GITHUB_STEP_SUMMARY
          echo "| high | **Yes (platform-team)** |" >> $GITHUB_STEP_SUMMARY
