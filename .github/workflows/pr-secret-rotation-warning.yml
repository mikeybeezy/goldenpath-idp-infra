# Owner: platform
name: Policy - Secret Rotation Warning (Soft Gate)

# Non-blocking PR check that warns when secrets are approaching rotation deadline
# This is a SOFT GATE - it posts a warning but does not block the PR
#
# ADR Reference: ADR-0158-platform-standalone-rds-bounded-context.md
# Runbook: docs/70-operations/runbooks/RB-0029-rds-manual-secret-rotation.md

on:
  pull_request:
    branches:
      - main
      - development
    types: [opened, synchronize, reopened]
    # Only trigger on infrastructure changes
    paths:
      - "envs/**"
      - "modules/**"
      - "bootstrap/**"
      - "gitops/**"

permissions:
  contents: read
  pull-requests: write
  id-token: write

env:
  # Warn when secrets are within this many days of rotation deadline
  WARNING_THRESHOLD_DAYS: 5

jobs:
  check-rotation-status:
    runs-on: ubuntu-latest
    # Only run on PRs targeting infrastructure-related paths
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Configure AWS credentials (dev)
        id: aws
        continue-on-error: true
        uses: aws-actions/configure-aws-credentials@v4.1.0
        with:
          aws-region: eu-west-2
          role-to-assume: ${{ secrets.TF_AWS_IAM_ROLE_DEV_APPLY }}

      - name: Check secret rotation status
        id: check
        if: steps.aws.outcome == 'success'
        run: |
          set -euo pipefail

          ENVIRONMENT="dev"
          ROTATION_DAYS=30
          WARNING_THRESHOLD="${WARNING_THRESHOLD_DAYS}"

          # Secret paths to check
          SECRET_PREFIXES=(
            "goldenpath/${ENVIRONMENT}/rds/master"
            "goldenpath/${ENVIRONMENT}/keycloak/postgres"
            "goldenpath/${ENVIRONMENT}/backstage/postgres"
          )

          WARNINGS=""
          OVERDUE=""

          for SECRET_PATH in "${SECRET_PREFIXES[@]}"; do
            # Get secret metadata (silently skip if not found)
            if ! SECRET_INFO=$(aws secretsmanager describe-secret --secret-id "${SECRET_PATH}" 2>/dev/null); then
              continue
            fi

            # Get last changed date
            LAST_CHANGED=$(echo "${SECRET_INFO}" | jq -r '.LastChangedDate // .CreatedDate // empty')
            if [[ -z "${LAST_CHANGED}" ]]; then
              continue
            fi

            # Calculate age in days
            LAST_CHANGED_EPOCH=$(date -d "${LAST_CHANGED}" +%s 2>/dev/null || date -j -f "%Y-%m-%dT%H:%M:%S" "${LAST_CHANGED%%.*}" +%s 2>/dev/null || echo "0")
            NOW_EPOCH=$(date +%s)
            AGE_DAYS=$(( (NOW_EPOCH - LAST_CHANGED_EPOCH) / 86400 ))

            # Determine status
            DEADLINE_DAYS=$((ROTATION_DAYS - AGE_DAYS))

            if [[ "${AGE_DAYS}" -ge "${ROTATION_DAYS}" ]]; then
              OVERDUE="${OVERDUE}- \`${SECRET_PATH}\`: **${AGE_DAYS} days old** (OVERDUE by $((AGE_DAYS - ROTATION_DAYS)) days)\n"
            elif [[ "${DEADLINE_DAYS}" -le "${WARNING_THRESHOLD}" ]]; then
              WARNINGS="${WARNINGS}- \`${SECRET_PATH}\`: ${AGE_DAYS} days old (due in ${DEADLINE_DAYS} days)\n"
            fi
          done

          # Set outputs
          if [[ -n "${OVERDUE}" ]]; then
            echo "status=overdue" >> "${GITHUB_OUTPUT}"
            echo "needs_comment=true" >> "${GITHUB_OUTPUT}"
          elif [[ -n "${WARNINGS}" ]]; then
            echo "status=warning" >> "${GITHUB_OUTPUT}"
            echo "needs_comment=true" >> "${GITHUB_OUTPUT}"
          else
            echo "status=ok" >> "${GITHUB_OUTPUT}"
            echo "needs_comment=false" >> "${GITHUB_OUTPUT}"
          fi

          # Store messages for comment
          echo "overdue<<EOF" >> "${GITHUB_OUTPUT}"
          echo -e "${OVERDUE}" >> "${GITHUB_OUTPUT}"
          echo "EOF" >> "${GITHUB_OUTPUT}"

          echo "warnings<<EOF" >> "${GITHUB_OUTPUT}"
          echo -e "${WARNINGS}" >> "${GITHUB_OUTPUT}"
          echo "EOF" >> "${GITHUB_OUTPUT}"

      - name: Post warning comment
        if: steps.check.outputs.needs_comment == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ steps.check.outputs.status }}';
            const overdue = `${{ steps.check.outputs.overdue }}`;
            const warnings = `${{ steps.check.outputs.warnings }}`;

            let emoji = status === 'overdue' ? 'âš ï¸' : 'âš ï¸';
            let header = status === 'overdue'
              ? 'Secret Rotation: OVERDUE'
              : 'Secret Rotation: Approaching Deadline';

            let body = `## ${emoji} ${header}

            **This is an informational warning and does not block this PR.**

            `;

            if (overdue) {
              body += `### Overdue Secrets (Immediate Rotation Required)
            ${overdue}

            `;
            }

            if (warnings) {
              body += `### Approaching Deadline
            ${warnings}

            `;
            }

            body += `### Action Recommended
            Consider rotating these secrets before merging infrastructure changes.

            **Runbook:** [RB-0029 Manual Secret Rotation](docs/70-operations/runbooks/RB-0029-rds-manual-secret-rotation.md)

            ---
            *This is a soft gate - it warns but does not block. Secret rotation compliance is enforced via daily scheduled checks.*
            `;

            // Check for existing comment from this workflow
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existingComment = comments.find(c =>
              c.user.type === 'Bot' &&
              c.body.includes('Secret Rotation:')
            );

            if (existingComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: body
              });
              console.log(`Updated existing comment #${existingComment.id}`);
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
              console.log('Created new warning comment');
            }

      - name: Summary
        if: always()
        run: |
          {
            echo "## Secret Rotation Check"
            echo ""
            if [[ "${{ steps.check.outputs.status }}" == "overdue" ]]; then
              echo "**Status:** âš ï¸ OVERDUE - Secrets need immediate rotation"
            elif [[ "${{ steps.check.outputs.status }}" == "warning" ]]; then
              echo "**Status:** âš ï¸ WARNING - Secrets approaching rotation deadline"
            elif [[ "${{ steps.check.outputs.status }}" == "ok" ]]; then
              echo "**Status:** âœ… OK - All secrets are within rotation policy"
            else
              echo "**Status:** ðŸš§ Skipped (AWS credentials not available or secrets not found)"
            fi
            echo ""
            echo "**Note:** This is a soft gate - informational only, does not block PRs."
            echo ""
            echo "**Runbook:** [RB-0029](docs/70-operations/runbooks/RB-0029-rds-manual-secret-rotation.md)"
          } >> "${GITHUB_STEP_SUMMARY}"
