name: Create ECR Registry

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        type: choice
        required: true
        options: [dev, test, staging, prod]
      registry_name:
        description: 'Registry name (e.g., wordpress-platform)'
        required: true
      owner:
        description: 'Team owner (e.g., app-team-wordpress)'
        required: true
      risk:
        description: 'Risk level'
        type: choice
        required: true
        options: [low, medium, high]

permissions:
  contents: write
  pull-requests: write

jobs:
  propose:
    name: Propose Registry Creation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Calculate Registry ID
        id: calc
        run: |
          # Convert wordpress-platform to REGISTRY_WORDPRESS_PLATFORM
          NAME="${{ inputs.registry_name }}"
          ID=$(echo "$NAME" | tr '-' '_' | tr '[:lower:]' '[:upper:]' | sed 's/^/REGISTRY_/')
          echo "id=$ID" >> $GITHUB_OUTPUT
          echo "âœ… Calculated ID: $ID"

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Validate inputs
        run: |
          # Validate registry name format
          if ! echo "${{ inputs.registry_name }}" | grep -qE '^[a-z][a-z0-9-]*$'; then
            echo "âŒ Registry name must be lowercase with hyphens only"
            exit 1
          fi

          # Validate owner format (relaxed)
          if ! echo "${{ inputs.owner }}" | grep -qE '^[a-z0-9-]+$'; then
            echo "âŒ Owner must be lowercase alphanumeric with dashes (e.g. platform-team, michael-babs)"
            exit 1
          fi

          echo "âœ… All inputs validated"

      - name: Update catalog (idempotent)
        run: |
          set -euo pipefail
          FILE="docs/catalogs/ecr-catalog.yaml"
          NAME="${{ inputs.registry_name }}"
          OWNER="${{ inputs.owner }}"
          RISK="${{ inputs.risk }}"
          ID="${{ steps.calc.outputs.id }}"
          ENV="${{ inputs.environment }}"

          # Ensure file exists with proper structure
          if [ ! -f "$FILE" ]; then
            cat > "$FILE" <<EOF
          version: "1.0"
          domain: "container-registries"
          owner: "platform-team"
          last_updated: "$(date -u +%Y-%m-%d)"
          managed_by: "platform-team"
          registries: {}
          EOF
          fi

          # Add/update the registry entry
          yq -i \
            ".registries.\"$NAME\".metadata.id = \"$ID\" |
             .registries.\"$NAME\".metadata.owner = \"$OWNER\" |
             .registries.\"$NAME\".metadata.risk = \"$RISK\" |
             .registries.\"$NAME\".metadata.status = \"pending\" |
             .registries.\"$NAME\".metadata.created_date = \"$(date -u +%Y-%m-%d)\" |
             .last_updated = \"$(date -u +%Y-%m-%d)\"" \
            "$FILE"

          echo "âœ… Updated catalog for registry: $NAME (ID: $ID)"

      - name: Update Terraform tfvars
        env:
          INPUT_ENVIRONMENT: ${{ inputs.environment }}
          INPUT_REGISTRY_NAME: ${{ inputs.registry_name }}
          INPUT_OWNER: ${{ inputs.owner }}
          INPUT_RISK: ${{ inputs.risk }}
          INPUT_ID: ${{ steps.calc.outputs.id }}
        run: |
          python3 -c '
          import os
          import sys

          env = os.environ.get("INPUT_ENVIRONMENT")
          tfvars_path = "envs/" + env + "/terraform.tfvars"
          name = os.environ.get("INPUT_REGISTRY_NAME")
          owner = os.environ.get("INPUT_OWNER")
          risk = os.environ.get("INPUT_RISK")
          reg_id = os.environ.get("INPUT_ID")

          # HCL Entry to insert
          new_entry = f"""
            "{name}" = {{
              metadata = {{
                id    = "{reg_id}"
                owner = "{owner}"
                risk  = "{risk}"
              }}
            }}
          """

          try:
              with open(tfvars_path, "r") as f:
                  content = f.read()
              
              if f"\"{name}\"" in content and "ecr_repositories" in content:
                  print(f"âš ï¸  Registry {name} appears to already exist in {tfvars_path}")
                  sys.exit(0)

              if "ecr_repositories = {" in content:
                  start_idx = content.find("ecr_repositories = {")
                  brace_count = 0
                  insert_idx = -1
                  
                  for i in range(start_idx, len(content)):
                      if content[i] == "{":
                          brace_count += 1
                      elif content[i] == "}":
                          brace_count -= 1
                          if brace_count == 0:
                              insert_idx = i
                              break
                  
                  if insert_idx != -1:
                      new_content = content[:insert_idx] + new_entry + content[insert_idx:]
                      with open(tfvars_path, "w") as f:
                          f.write(new_content)
                      print(f"âœ… Injected {name} into existing ecr_repositories block.")
                  else:
                      print("âŒ Error: Could not parse ecr_repositories block structure.")
                      sys.exit(1)
              else:
                  with open(tfvars_path, "a") as f:
                      f.write(f"\n# Registry Catalog\necr_repositories = {{\n{new_entry}\n}}\n")
                  print(f"âœ… Created new ecr_repositories block with {name}.")

          except Exception as e:
              print(f"âŒ Error updating tfvars: {e}")
              sys.exit(1)
          '

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Configure AWS credentials (for Plan)
        uses: aws-actions/configure-aws-credentials@v4.1.0
        with:
          aws-region: eu-west-2
          role-to-assume: ${{ secrets.TF_AWS_IAM_ROLE_DEV }}

      - name: Terraform Init
        run: |
          terraform -chdir=envs/${{ inputs.environment }} init -backend=false

      - name: Inline Terraform Plan (Targeted)
        id: plan
        run: |
          echo "ğŸ“ Running targeted plan for module.ecr_repositories[\"${{ inputs.registry_name }}\"]..."
          
          # We use -lock=false because we are only planning a subset and don't want to block CI
          # We provide a dummy build_id if needed, but tfvars usually has it.
          
          terraform -chdir=envs/${{ inputs.environment }} plan \
            -target="module.ecr_repositories[\"${{ inputs.registry_name }}\"]" \
            -lock=false \
            -no-color > raw_plan.txt || echo "Plan failed" > raw_plan.txt
          
          # Extract only the resource changes for the PR body to keep it clean
          # We look for the section starting with 'Terraform will perform the following actions:'
          sed -n '/Terraform will perform the following actions:/,$p' raw_plan.txt > plan.txt
          
          # Clean up for PR body (Markdown wrapper)
          echo "PLAN_BODY<<EOF" >> $GITHUB_ENV
          echo "<details><summary>ğŸ“„ <strong>Targeted Terraform Plan</strong></summary>" >> $GITHUB_ENV
          echo "" >> $GITHUB_ENV
          echo "This plan was generated using a **bounded context** strategy (\`-target\`), focusing only on the new ECR repository." >> $GITHUB_ENV
          echo "" >> $GITHUB_ENV
          echo "\`\`\`hcl" >> $GITHUB_ENV
          cat plan.txt >> $GITHUB_ENV
          echo "\`\`\`" >> $GITHUB_ENV
          echo "</details>" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Create PR
        uses: peter-evans/create-pull-request@v6
        with:
          base: development
          branch: "registry/create-${{ inputs.registry_name }}"
          title: "ğŸ—ï¸ Create ECR Registry: ${{ inputs.registry_name }} (${{ inputs.environment }})"
          commit-message: "registry: create ${{ inputs.registry_name }} in ${{ inputs.environment }}"
          body: |
            ## ğŸ—ï¸ ECR Registry Creation Request

            **Registry:** `${{ inputs.registry_name }}`
            **Environment:** `${{ inputs.environment }}`
            **Owner:** `${{ inputs.owner }}`
            **Risk Level:** `${{ inputs.risk }}`
            **ID:** `${{ steps.calc.outputs.id }}`

            ---

            ## ğŸ¤– Inline Terraform Plan
            
            ${{ env.PLAN_BODY }}

            ---

            ## ğŸ”’ Security Controls (Auto-Applied)

            Based on risk level **`${{ inputs.risk }}`**, the following security controls will be automatically configured:

            ${{ inputs.risk == 'high' && '
            ### ğŸ”´ High Risk Configuration
            - âœ… **Encryption:** KMS (customer-managed keys)
            - âœ… **Tag Mutability:** IMMUTABLE (tags cannot be overwritten)
            - âœ… **Image Retention:** Keep last 50 images
            - âœ… **Image Scanning:** Enhanced scanning on every push
            ' || inputs.risk == 'medium' && '
            ### ğŸŸ¡ Medium Risk Configuration
            - âœ… **Encryption:** AES256 (AWS-managed)
            - âœ… **Tag Mutability:** MUTABLE (tags can be overwritten)
            - âœ… **Image Retention:** Keep last 30 images
            - âœ… **Image Scanning:** Standard scanning on every push
            ' || '
            ### ğŸŸ¢ Low Risk Configuration
            - âœ… **Encryption:** AES256 (AWS-managed)
            - âœ… **Tag Mutability:** MUTABLE (tags can be overwritten)
            - âœ… **Image Retention:** Keep last 20 images
            - âœ… **Image Scanning:** Standard scanning on every push
            ' }}

            ---

            ## ğŸ“‹ Changes Policy
            - âœ… Added to registry catalog (`docs/catalogs/ecr-catalog.yaml`)
            - âœ… Updated documentation catalog ([REGISTRY_CATALOG.md](docs/REGISTRY_CATALOG.md))
            - âœ… Added to Terraform tfvars (`envs/${{ inputs.environment }}/terraform.tfvars`)

            ---
            
            ## ğŸš€ Next Steps
            1. **Merge** this PR (Plan is already verified above).
            2. **Run Apply** workflow (Automated next step).

            /cc @platform-team
          labels: |
            ecr-registry
            platform-team
            ${{ inputs.environment }}
