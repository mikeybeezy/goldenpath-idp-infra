---
id: 35_TOOLING_SECRETS_LIFECYCLE
title: Tooling Secrets Lifecycle
type: policy
relates_to:
  - 35_SECRET_MANAGEMENT
  - ADR-0006-platform-secrets-strategy
  - ADR-0157-platform-multi-tenant-rds-architecture
  - RB-0029-rds-manual-secret-rotation
category: compliance
---

## Tooling Secrets Lifecycle

This document describes how secrets are managed for platform tooling applications, including when they are generated, how they are stored, and the sync mechanism to Kubernetes.

### Related ADRs

- [ADR-0006: Secrets Strategy](../adrs/ADR-0006-platform-secrets-strategy.md)
- [ADR-0157: Multi-Tenant RDS Architecture](../adrs/ADR-0157-platform-multi-tenant-rds-architecture.md)

## Secrets Architecture

```text
┌─────────────────────────────────────────────────────────────────────────┐
│                          SECRET LIFECYCLE                                │
└─────────────────────────────────────────────────────────────────────────┘

  GENERATION                    STORAGE                      CONSUMPTION
  ──────────                    ───────                      ───────────

  ┌─────────────┐          ┌─────────────────┐          ┌─────────────────┐
  │  Terraform  │          │  AWS Secrets    │          │   Kubernetes    │
  │  (auto-gen) │────────▶│    Manager      │────────▶│     Secret      │
  └─────────────┘          └─────────────────┘          └─────────────────┘
        │                         │                            │
        │                         │                            │
  random_password            JSON blob                   K8s Secret
  resource                   with all                    mounted as
                            credentials                  env vars

                                    │
                                    │
                          ┌─────────┴─────────┐
                          │  External Secrets │
                          │     Operator      │
                          └───────────────────┘
```

## Secret Categories

### 1. Auto-Generated Secrets (Terraform)

These secrets are created automatically during Terraform apply:

|Secret|Generator|When Created|Stored In|
|--------|-----------|--------------|-----------|
|RDS Master Password|`random_password.master`|RDS creation|`goldenpath/{env}/platform-db/master`|
|Keycloak DB Password|`random_password.app["keycloak"]`|RDS creation|`goldenpath/{env}/keycloak/postgres`|
|Backstage DB Password|`random_password.app["backstage"]`|RDS creation|`goldenpath/{env}/backstage/postgres`|

### 2. Manual Secrets (Pre-requisites)

These secrets must be created manually before deployment:

|Secret|Purpose|Path|When Needed|
|--------|---------|------|-------------|
|Keycloak Admin|Initial admin password|`goldenpath/{env}/keycloak/admin`|Before Keycloak deploy|
|GitHub Token|Backstage GitHub integration|`goldenpath/{env}/backstage/secrets`|Before Backstage deploy|
|OIDC Client Secret|Backstage auth|`goldenpath/{env}/backstage/oidc`|After Keycloak configured|

### 3. App-Generated Secrets

These are created by applications after deployment:

|Secret|Generated By|Stored In|
|--------|--------------|-----------|
|OIDC Client Secrets|Keycloak|Keycloak internal DB|
|API Tokens|Kong|Kong internal storage|

## Secret Generation Timeline

```text
┌──────────────────────────────────────────────────────────────────────────┐
│                     DEPLOYMENT TIMELINE                                   │
└──────────────────────────────────────────────────────────────────────────┘

  T-1: Manual Prerequisites
  ─────────────────────────
  Create these secrets in AWS Secrets Manager before Terraform apply:

  • goldenpath/{env}/keycloak/admin
    └── { "admin-password": "<your-secure-password>" }

  • goldenpath/{env}/backstage/secrets
    └── { "token": "ghp_xxxxx" }

  ──────────────────────────────────────────────────────────────────────────

  T0: Terraform Apply (Phase 0)
  ─────────────────────────────
  Auto-generated by Terraform:

  • goldenpath/{env}/platform-db/master     ◄── RDS master credentials
  • goldenpath/{env}/keycloak/postgres      ◄── Keycloak DB credentials
  • goldenpath/{env}/backstage/postgres     ◄── Backstage DB credentials

  ──────────────────────────────────────────────────────────────────────────

  T1: EKS Cluster Ready (Phase 1)
  ───────────────────────────────
  No new secrets created.
  IRSA roles enable ESO to access Secrets Manager.

  ──────────────────────────────────────────────────────────────────────────

  T2: Platform Bootstrap (Phase 2)
  ────────────────────────────────
  External Secrets Operator deployed.
  ClusterSecretStore configured.

  Secrets synced to Kubernetes:
  • keycloak-admin-secret         (from goldenpath/{env}/keycloak/admin)
  • keycloak-postgres-secret      (from goldenpath/{env}/keycloak/postgres)
  • backstage-postgres-secret     (from goldenpath/{env}/backstage/postgres)
  • backstage-secrets             (from multiple sources)

  ──────────────────────────────────────────────────────────────────────────

  T3: Tooling Apps Deploy (Phase 3)
  ─────────────────────────────────
  Apps consume secrets via:
  • Environment variables (existingSecret references)
  • Mounted secret volumes

  ──────────────────────────────────────────────────────────────────────────

  T4: Post-Deploy Configuration
  ─────────────────────────────
  After Keycloak is running:

  • Create Backstage OIDC client in Keycloak
  • Store client secret in AWS Secrets Manager:
    goldenpath/{env}/backstage/oidc
    └── { "client-secret": "<from-keycloak>" }
```

## Secret Paths Reference

### Naming Convention

```text
goldenpath/{environment}/{component}/{secret-type}
```

### Complete Secret Inventory

|Path|Type|Contents|Created By|
|------|------|----------|------------|
|`goldenpath/dev/platform-db/master`|Auto|`username`, `password`, `host`, `port`, `dbname`|Terraform|
|`goldenpath/dev/keycloak/admin`|Manual|`admin-password`|Operator|
|`goldenpath/dev/keycloak/postgres`|Auto|`username`, `password`, `host`, `port`, `dbname`|Terraform|
|`goldenpath/dev/backstage/postgres`|Auto|`username`, `password`, `host`, `port`, `dbname`|Terraform|
|`goldenpath/dev/backstage/secrets`|Manual|`token`|Operator|
|`goldenpath/dev/backstage/oidc`|Manual|`client-secret`|Operator|
|`goldenpath/dev/kong/admin`|Optional|`admin-token`|Operator|

## Creating Manual Secrets

### Keycloak Admin Password

```bash
# Create secret for Keycloak admin
aws secretsmanager create-secret \
  --name "goldenpath/dev/keycloak/admin" \
  --description "Keycloak admin credentials" \
  --secret-string '{"admin-password":"<secure-password-here>"}'
```

### GitHub Token for Backstage

```bash
# Create GitHub PAT with repo scope at https://github.com/settings/tokens
aws secretsmanager create-secret \
  --name "goldenpath/dev/backstage/secrets" \
  --description "GitHub token for Backstage" \
  --secret-string '{"token":"ghp_xxxxxxxxxxxxx"}'
```

### OIDC Client Secret (After Keycloak Setup)

```bash
# After creating Backstage client in Keycloak:
aws secretsmanager create-secret \
  --name "goldenpath/dev/backstage/oidc" \
  --description "OIDC client secret for Backstage" \
  --secret-string '{"client-secret":"<from-keycloak-ui>"}'
```

## ExternalSecrets Configuration

### ClusterSecretStore

```yaml
# gitops/kustomize/bases/external-secrets/cluster-secret-store.yaml
apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: aws-secretsmanager
spec:
  provider:
    aws:
      service: SecretsManager
      region: eu-west-2
      auth:
        jwt:
          serviceAccountRef:
            name: external-secrets
            namespace: external-secrets
```

### ExternalSecret Example

```yaml
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: keycloak-admin-secret
  namespace: keycloak
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: aws-secretsmanager
  target:
    name: keycloak-admin-secret
    creationPolicy: Owner
  data:
    - secretKey: admin-password
      remoteRef:
        key: goldenpath/dev/keycloak/admin
        property: admin-password
```

## Secret Rotation

### Auto-Generated Secrets

For Terraform-managed secrets (DB passwords):

1. Update Terraform to regenerate: `terraform taint random_password.app["keycloak"]`
2. Apply: `terraform apply`
3. Restart affected pods to pick up new credentials

### Manual Secrets

For operator-managed secrets:

```bash
# Update existing secret
aws secretsmanager update-secret \
  --secret-id "goldenpath/dev/keycloak/admin" \
  --secret-string '{"admin-password":"<new-password>"}'

# Force ESO refresh (or wait for refreshInterval)
kubectl annotate externalsecret keycloak-admin-secret -n keycloak \
  force-sync=$(date +%s) --overwrite
```

## Verification Commands

### Check Secret Exists in AWS

```bash
aws secretsmanager list-secrets \
  --filter Key=name,Values=goldenpath/dev \
  --query 'SecretList[].Name'
```

### Check ExternalSecret Status

```bash
kubectl get externalsecret -A
kubectl describe externalsecret keycloak-postgres-secret -n keycloak
```

### Verify K8s Secret Contents

```bash
kubectl get secret keycloak-postgres-secret -n keycloak -o yaml
kubectl get secret keycloak-postgres-secret -n keycloak \
  -o jsonpath='{.data.host}' | base64 -d
```

## Troubleshooting

### ExternalSecret Shows "SecretSyncedError"

```bash
# Check ESO logs
kubectl logs -n external-secrets -l app.kubernetes.io/name=external-secrets

# Common causes:
# - Secret doesn't exist in AWS
# - IRSA role doesn't have permission
# - Wrong secret path or property name
```

### Secret Not Updating After AWS Change

```bash
# Force refresh
kubectl annotate externalsecret <name> -n <ns> \
  force-sync=$(date +%s) --overwrite

# Or delete and let it recreate
kubectl delete externalsecret <name> -n <ns>
# ArgoCD will recreate from Git
```

## Pre-Deploy Checklist

Before deploying the platform, ensure:

- [ ] Manual secrets created in AWS Secrets Manager:
  - [ ] `goldenpath/{env}/keycloak/admin`
  - [ ] `goldenpath/{env}/backstage/secrets`
- [ ] IAM role for ESO has SecretsManager read permissions
- [ ] OIDC provider configured for IRSA
- [ ] ClusterSecretStore manifest in Git

## Related Documentation

- [Platform RDS Architecture](30_PLATFORM_RDS_ARCHITECTURE.md)
- [ADR-0006: Secrets Strategy](../adrs/ADR-0006-platform-secrets-strategy.md)
- [Secret Management](../60-security/35_SECRET_MANAGEMENT.md)
- [Rebuild Sequence](06_REBUILD_SEQUENCE.md)
