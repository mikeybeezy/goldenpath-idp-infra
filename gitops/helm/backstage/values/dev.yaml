# Backstage Helm Values - Dev Environment
# Chart: backstage/backstage v1.12.0
# Managed by scripts/standardize_metadata.py
governance:
  id: HELM_BACKSTAGE_METADATA
  owner: null
  risk_profile: null
  reliability: null

# -----------------------------------------------------------------------------
# Image Configuration - Pinned Version
# -----------------------------------------------------------------------------
backstage:
  image:
    registry: ghcr.io
    repository: backstage/backstage
    tag: 1.24.0
    pullPolicy: IfNotPresent

# -----------------------------------------------------------------------------
# App Configuration
# -----------------------------------------------------------------------------
appConfig:
  app:
    baseUrl: https://backstage.dev.goldenpath.io
    title: Goldenpath IDP

  backend:
    baseUrl: https://backstage.dev.goldenpath.io
    cors:
      origin: https://backstage.dev.goldenpath.io
    database:
      client: pg
      connection:
        host: ${POSTGRES_HOST}
        port: ${POSTGRES_PORT}
        user: ${POSTGRES_USER}
        password: ${POSTGRES_PASSWORD}

  # Catalog locations
  catalog:
    locations:
      - type: url
        target: https://raw.githubusercontent.com/mikeybeezy/goldenpath-idp-infra/main/backstage/templates/ci-apply-dev/template.yaml
        rules:
          - allow:
              - Template
      - type: url
        target: https://raw.githubusercontent.com/mikeybeezy/goldenpath-idp-infra/main/backstage/templates/app-template/template.yaml
        rules:
          - allow:
              - Template

  # GitHub Integration
  integrations:
    github:
      - host: github.com
        token: ${GITHUB_TOKEN}

  # Auth configuration (OIDC via Keycloak)
  auth:
    environment: development
    providers:
      oidc:
        development:
          metadataUrl: https://keycloak.dev.goldenpath.io/realms/goldenpath/.well-known/openid-configuration
          clientId: backstage
          clientSecret: ${OIDC_CLIENT_SECRET}

# -----------------------------------------------------------------------------
# PostgreSQL (Bundled)
# -----------------------------------------------------------------------------
postgresql:
  enabled: false
  image:
    registry: docker.io
    repository: bitnami/postgresql
    tag: 15.6.0-debian-12-r8
  auth:
    existingSecret: backstage-postgres-secret
    secretKeys:
      adminPasswordKey: postgres-password
      userPasswordKey: password
  primary:
    persistence:
      enabled: true
      size: 8Gi

# -----------------------------------------------------------------------------
# Ingress
# -----------------------------------------------------------------------------
ingress:
  enabled: true
  className: kong
  host: backstage.dev.goldenpath.io
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-staging

# -----------------------------------------------------------------------------
# Environment Variables from Secrets
# -----------------------------------------------------------------------------
extraEnvVarsSecrets:
  - backstage-secrets

# -----------------------------------------------------------------------------
# Resource Limits for Dev
# -----------------------------------------------------------------------------
resources:
  requests:
    cpu: 100m
    memory: 256Mi
  limits:
    cpu: 500m
    memory: 1Gi

# -----------------------------------------------------------------------------
# Extra Manifests (External Secrets)
# -----------------------------------------------------------------------------
extraDeploy:
  - |
    apiVersion: external-secrets.io/v1beta1
    kind: ExternalSecret
    metadata:
      name: backstage-postgres-secret
    spec:
      refreshInterval: 1m
      secretStoreRef:
        name: aws-secretsmanager
        kind: ClusterSecretStore
      target:
        name: backstage-postgres-secret
        creationPolicy: Owner
      data:
      - secretKey: password
        remoteRef:
          key: goldenpath/dev/backstage/postgres
          property: password
      - secretKey: host
        remoteRef:
          key: goldenpath/dev/backstage/postgres
          property: host
      - secretKey: port
        remoteRef:
          key: goldenpath/dev/backstage/postgres
          property: port
      - secretKey: username
        remoteRef:
          key: goldenpath/dev/backstage/postgres
          property: username
  - |
    apiVersion: external-secrets.io/v1beta1
    kind: ExternalSecret
    metadata:
      name: backstage-secrets
    spec:
      refreshInterval: 1m
      secretStoreRef:
        name: aws-secretsmanager
        kind: ClusterSecretStore
      target:
        name: backstage-secrets
        creationPolicy: Owner
      data:
      - secretKey: GITHUB_TOKEN
        remoteRef:
          key: goldenpath/dev/backstage/github
          property: token
      - secretKey: OIDC_CLIENT_SECRET
        remoteRef:
          key: goldenpath/dev/backstage/oidc
          property: client-secret

