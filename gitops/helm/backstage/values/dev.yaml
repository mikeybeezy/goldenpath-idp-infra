# Backstage Helm Values - Dev Environment
# Chart: PlatformersCommunity/backstage-helm-chart
# Managed by scripts/standardize_metadata.py
governance:
  id: HELM_BACKSTAGE_METADATA
  owner: null
  risk_profile: null
  reliability: null

# -----------------------------------------------------------------------------
# Image Configuration - Pinned Version
# -----------------------------------------------------------------------------
image:
  repository: ghcr.io/guymenahem/
  name: backstage-platformers
  tag: 0.0.1
  pullPolicy: IfNotPresent

# -----------------------------------------------------------------------------
# App Configuration (YAML string format for Platformers chart)
# -----------------------------------------------------------------------------
appConfig: |
  app:
    baseUrl: https://backstage.dev.goldenpath.io
    title: Goldenpath IDP

  backend:
    baseUrl: https://backstage.dev.goldenpath.io
    cors:
      origin: https://backstage.dev.goldenpath.io
    database:
      client: pg
      connection:
        host: ${POSTGRES_HOST}
        port: ${POSTGRES_PORT}
        user: ${POSTGRES_USER}
        password: ${POSTGRES_PASSWORD}
    auth:
      keys:
        - secret: ${BACKEND_AUTH_SECRET}

  integrations:
    github:
      - host: github.com
        token: ${GITHUB_TOKEN}

  auth:
    environment: development
    providers:
      oidc:
        development:
          metadataUrl: https://keycloak.dev.goldenpath.io/realms/goldenpath/.well-known/openid-configuration
          clientId: backstage
          clientSecret: ${OIDC_CLIENT_SECRET}

  catalog:
    locations:
      - type: url
        target: https://raw.githubusercontent.com/mikeybeezy/goldenpath-idp-infra/main/backstage/templates/ci-apply-dev/template.yaml
        rules:
          - allow:
              - Template
      - type: url
        target: https://raw.githubusercontent.com/mikeybeezy/goldenpath-idp-infra/main/backstage/templates/app-template/template.yaml
        rules:
          - allow:
              - Template

  kubernetes:
    serviceLocatorMethod:
      type: multiTenant
    clusterLocatorMethods:
      - type: config
        clusters:
          - url: https://kubernetes.default.svc
            name: local
            authProvider: serviceAccount
            skipTLSVerify: false
            skipMetricsLookup: true

# -----------------------------------------------------------------------------
# PostgreSQL (External - RDS)
# -----------------------------------------------------------------------------
postgresql:
  enabled: false

# -----------------------------------------------------------------------------
# Ingress
# -----------------------------------------------------------------------------
ingress:
  enabled: true
  className: kong
  host: backstage.dev.goldenpath.io
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-staging

# -----------------------------------------------------------------------------
# Environment Variables
# -----------------------------------------------------------------------------
extraEnvVarsSecrets:
  - backstage-secrets
  - backstage-postgres-secret

extraEnvVars:
  - name: BACKEND_AUTH_SECRET
    value: "random-generated-secret-key-for-backend-auth"
  - name: POSTGRES_HOST
    valueFrom:
      secretKeyRef:
        name: backstage-postgres-secret
        key: host
  - name: POSTGRES_PORT
    valueFrom:
      secretKeyRef:
        name: backstage-postgres-secret
        key: port
  - name: POSTGRES_USER
    valueFrom:
      secretKeyRef:
        name: backstage-postgres-secret
        key: username
  - name: POSTGRES_PASSWORD
    valueFrom:
      secretKeyRef:
        name: backstage-postgres-secret
        key: password

# -----------------------------------------------------------------------------
# Resource Limits for Dev
# -----------------------------------------------------------------------------
resources:
  requests:
    cpu: 100m
    memory: 256Mi
  limits:
    cpu: 500m
    memory: 1Gi

# -----------------------------------------------------------------------------
# Extra Manifests (External Secrets)
# -----------------------------------------------------------------------------
extraDeploy:
  - |
    apiVersion: external-secrets.io/v1beta1
    kind: ExternalSecret
    metadata:
      name: backstage-postgres-secret
    spec:
      refreshInterval: 1m
      secretStoreRef:
        name: aws-secretsmanager
        kind: ClusterSecretStore
      target:
        name: backstage-postgres-secret
        creationPolicy: Owner
      data:
      - secretKey: password
        remoteRef:
          key: goldenpath/dev/backstage/postgres
          property: password
      - secretKey: host
        remoteRef:
          key: goldenpath/dev/backstage/postgres
          property: host
      - secretKey: port
        remoteRef:
          key: goldenpath/dev/backstage/postgres
          property: port
      - secretKey: username
        remoteRef:
          key: goldenpath/dev/backstage/postgres
          property: username
  - |
    apiVersion: external-secrets.io/v1beta1
    kind: ExternalSecret
    metadata:
      name: backstage-secrets
    spec:
      refreshInterval: 1m
      secretStoreRef:
        name: aws-secretsmanager
        kind: ClusterSecretStore
      target:
        name: backstage-secrets
        creationPolicy: Owner
      data:
      - secretKey: GITHUB_TOKEN
        remoteRef:
          key: goldenpath/dev/backstage/secrets
          property: token
      - secretKey: OIDC_CLIENT_SECRET
        remoteRef:
          key: goldenpath/dev/backstage/secrets
          property: client-secret
