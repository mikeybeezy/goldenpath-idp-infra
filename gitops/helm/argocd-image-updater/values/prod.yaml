# Argo CD Image Updater - Production Environment
# Chart: argoproj/argocd-image-updater
# Purpose: Update image tags in Git (prod apps use MANUAL sync)

# -----------------------------------------------------------------------------
# Core Configuration
# -----------------------------------------------------------------------------
image:
  repository: quay.io/argoprojlabs/argocd-image-updater
  tag: v0.12.2
  pullPolicy: IfNotPresent

# HA for production
replicaCount: 2

# -----------------------------------------------------------------------------
# Argo CD Integration
# -----------------------------------------------------------------------------
config:
  argocd:
    grpcWeb: true
    serverAddress: argocd-server.argocd.svc.cluster.local
    insecure: true
    plaintext: false

  logLevel: info

  gitCommitUser: argocd-image-updater
  gitCommitMail: image-updater@goldenpath.dev
  gitCommitSignOff: true
  gitCommitMessageTemplate: |
    build: update image {{ .AppName }} to {{ .NewImage }}

    Environment: production
    Image: {{ .Image.Name }}
    Old tag: {{ .OldTag }}
    New tag: {{ .NewTag }}

    REQUIRES MANUAL SYNC: This change will not auto-deploy.
    Run: argocd app sync {{ .AppName }}

    Signed-off-by: argocd-image-updater <image-updater@goldenpath.dev>

# -----------------------------------------------------------------------------
# Registry Configuration
# -----------------------------------------------------------------------------
  registries:
    - name: ECR
      api_url: https://593517239005.dkr.ecr.eu-west-2.amazonaws.com
      prefix: 593517239005.dkr.ecr.eu-west-2.amazonaws.com
      ping: yes
      insecure: no
      credentials: pullsecret:argocd/ecr-credentials

# -----------------------------------------------------------------------------
# Service Account
# -----------------------------------------------------------------------------
serviceAccount:
  create: true
  name: argocd-image-updater
  annotations:
    # eks.amazonaws.com/role-arn: arn:aws:iam::593517239005:role/argocd-image-updater-prod

# -----------------------------------------------------------------------------
# RBAC
# -----------------------------------------------------------------------------
rbac:
  enabled: true

# -----------------------------------------------------------------------------
# Metrics
# -----------------------------------------------------------------------------
metrics:
  enabled: true
  serviceMonitor:
    enabled: true
    namespace: argocd
    labels:
      release: kube-prometheus-stack

# -----------------------------------------------------------------------------
# GitHub App Authentication for Git Write-back
# See: RB-0036-github-app-image-updater.md
# -----------------------------------------------------------------------------
extraEnv:
  - name: ARGOCD_IMAGE_UPDATER_GIT_WRITE_BACK_TARGET
    value: "git"
  - name: GIT_AUTH_METHOD
    value: "github-app"
  - name: GITHUB_APP_ID
    valueFrom:
      secretKeyRef:
        name: github-app-image-updater
        key: app-id
        optional: true  # Set to false once secret exists
  - name: GITHUB_APP_INSTALLATION_ID
    valueFrom:
      secretKeyRef:
        name: github-app-image-updater
        key: installation-id
        optional: true  # Set to false once secret exists

extraVolumes:
  - name: github-app-creds
    secret:
      secretName: github-app-image-updater
      optional: true  # Set to false once secret exists - allows cluster to deploy before pipeline enabled

extraVolumeMounts:
  - name: github-app-creds
    mountPath: /app/config/github-app
    readOnly: true

# -----------------------------------------------------------------------------
# Resources (production sizing)
# -----------------------------------------------------------------------------
resources:
  requests:
    cpu: 100m
    memory: 128Mi
  limits:
    cpu: 500m
    memory: 512Mi

# -----------------------------------------------------------------------------
# Pod Disruption Budget (HA)
# -----------------------------------------------------------------------------
pdb:
  enabled: true
  minAvailable: 1

# -----------------------------------------------------------------------------
# Pod Configuration
# -----------------------------------------------------------------------------
podSecurityContext:
  runAsNonRoot: true
  runAsUser: 1000
  fsGroup: 1000

securityContext:
  allowPrivilegeEscalation: false
  readOnlyRootFilesystem: true
  capabilities:
    drop:
      - ALL

# -----------------------------------------------------------------------------
# Topology Spread
# -----------------------------------------------------------------------------
topologySpreadConstraints:
  - maxSkew: 1
    topologyKey: topology.kubernetes.io/zone
    whenUnsatisfiable: ScheduleAnyway
    labelSelector:
      matchLabels:
        app.kubernetes.io/name: argocd-image-updater
