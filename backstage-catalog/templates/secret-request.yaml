apiVersion: scaffolder.backstage.io/v1beta3
kind: Template
metadata:
  name: secret-request
  title: Request Application Secret
  description: |
    Request a new secret in AWS Secrets Manager.
    Creates a governed request file and PR for approval.
    High-risk secrets require platform-team review.
  tags:
    - aws
    - secrets
    - security
    - infrastructure
    - self-service
spec:
  owner: platform-team
  type: infrastructure

  parameters:
    - title: Secret Details
      required:
        - service_name
        - secret_name
        - secret_type
        - description
        - risk
        - environment
        - namespace
        - k8s_secret_name
        - requester
      properties:
        service_name:
          title: Service Name
          type: string
          description: Application or service that needs this secret (e.g., payments, auth)
          pattern: '^[a-z][a-z0-9-]{2,30}$'
          ui:autofocus: true
          ui:help: "3-31 chars, lowercase letters/numbers/hyphens. Must start with a letter."
        secret_name:
          title: Secret Name
          type: string
          description: Name for the secret (e.g., db-credentials, api-key)
          pattern: '^[a-z][a-z0-9-]{2,30}$'
          ui:help: "3-31 chars, lowercase letters/numbers/hyphens. Must start with a letter."
        secret_type:
          title: Secret Type
          type: string
          description: Classification determines rotation defaults and policy
          enum:
            - database-credentials
            - api-key
            - oauth-client
            - webhook-secret
            - signing-key
            - encryption-key
            - tls-private-key
            - container-registry-credential
            - third-party-token
            - generic
          default: generic
        description:
          title: Description
          type: string
          description: What is this secret for? (Required for audit trail)
          ui:widget: textarea
          ui:options:
            rows: 3
        risk:
          title: Risk Level
          type: string
          enum:
            - low
            - medium
            - high
          default: medium
          description: |
            low: No approval, 0-day recovery window
            medium: No approval, 7-day recovery window
            high: Requires platform-team approval, 30-day recovery window
        environment:
          title: Environment
          type: string
          description: Target environment for the secret
          enum:
            - dev
            - staging
            - prod
          default: dev
        rotation:
          title: Rotation Class
          type: string
          description: How often the secret should be rotated
          enum:
            - none
            - standard
            - high
          default: standard
        namespace:
          title: K8s Namespace
          type: string
          description: Namespace where ESO will sync the secret
          default: default
          pattern: '^[a-z][a-z0-9-]{0,62}$'
        k8s_secret_name:
          title: K8s Secret Name
          type: string
          description: Name of the Kubernetes secret (how pods will reference it)
          pattern: '^[a-z][a-z0-9-]{2,62}$'
        domain:
          title: Business Domain
          type: string
          description: Business domain for governance tracking
          enum:
            - platform-core
            - delivery
            - identity
            - catalog
            - observability
            - governance
            - security
            - cost
          default: platform-core
        owner:
          title: Owner Team
          type: string
          description: Team responsible for this secret
          enum:
            - app-team
            - platform-team
            - security-team
            - operations-team
            - sre-team
            - database-team
          default: app-team
        requester:
          title: Your Username
          type: string
          description: Your GitHub username (for tracking)
          pattern: '^[a-z0-9-]+$'

  steps:
    - id: trigger-workflow
      name: Trigger Secret Request Workflow
      action: github:actions:dispatch
      input:
        repoUrl: github.com?owner=mikeybeezy&repo=goldenpath-idp-infra
        workflowId: request-app-secret.yml
        branchOrTagName: main
        workflowInputs:
          base_branch: development
          environment: ${{ parameters.environment }}
          service_name: ${{ parameters.service_name }}
          secret_name: ${{ parameters.secret_name }}
          secret_type: ${{ parameters.secret_type }}
          owner: ${{ parameters.owner }}
          domain: ${{ parameters.domain }}
          risk: ${{ parameters.risk }}
          rotation: ${{ parameters.rotation }}
          recovery_window: ${{ parameters.risk == 'high' && '30' || parameters.risk == 'medium' && '7' || '0' }}
          description: ${{ parameters.description }}
          namespace: ${{ parameters.namespace }}
          k8s_secret_name: ${{ parameters.k8s_secret_name }}

  output:
    links:
      - title: Open Workflow Runs
        url: https://github.com/mikeybeezy/goldenpath-idp-infra/actions/workflows/request-app-secret.yml
      - title: PR Link (filtered by branch)
        url: https://github.com/mikeybeezy/goldenpath-idp-infra/pulls?q=is%3Apr+head%3Asecret%2Frequest-${{ parameters.service_name }}-${{ parameters.secret_name }}
      - title: PR List (fallback)
        url: https://github.com/mikeybeezy/goldenpath-idp-infra/pulls
